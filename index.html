<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î§Î¬ÏÏ„Î·Ï‚ Î Î¬ÏÎ½Î·Î¸Î±Ï‚ - AI Edition</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        #map { width: 100%; height: 100vh; z-index: 1; }

        /* Î£Ï„Ï…Î» Î³Î¹Î± Ï„Î¿ Popup */
        .custom-popup .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
            text-align: center;
        }
        .popup-title { font-size: 18px; font-weight: bold; color: #2c3e50; display: block; }
        .popup-desc { font-size: 14px; color: #555; }

        /* ÎšÎ¿Ï…Ï„Î¯ Ï„Î¯Ï„Î»Î¿Ï… */
        .info-box {
            position: absolute; top: 20px; left: 50px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); max-width: 250px;
        }
        .info-box h2 { margin: 0 0 5px 0; font-size: 18px; color: #2e7d32; }
        .info-box p { margin: 0; font-size: 12px; color: #666; }

        /* ÎšÎ¿Ï…Ï„Î¹Î¬ Î•Î»Î­Î³Ï‡Î¿Ï… */
        .controls-box {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            display: flex; gap: 10px;
            flex-wrap: wrap; 
            justify-content: flex-end;
        }
        
        .control-btn {
            background: white; border: none; padding: 10px 15px;
            border-radius: 8px; cursor: pointer; font-size: 14px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            transition: background 0.2s;
            font-weight: bold;
            display: flex; align-items: center; gap: 5px;
            position: relative;
        }

        /* --- TOOLTIP STYLES --- */
        .control-btn[data-tooltip]:hover::after,
        .ai-analyze-btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 115%; left: 50%; transform: translateX(-50%);
            background-color: white; color: #333;
            padding: 8px 12px; border-radius: 6px; font-size: 13px;
            white-space: nowrap; opacity: 0; animation: fadeInTooltip 0.3s forwards;
            pointer-events: none; box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            z-index: 1001; border: 1px solid #f0f0f0; font-weight: normal;
        }
        .control-btn[data-tooltip]:hover::before,
        .ai-analyze-btn[data-tooltip]:hover::before {
            content: ''; position: absolute; top: 105%; left: 50%;
            transform: translateX(-50%); border-width: 6px; border-style: solid;
            border-color: transparent transparent white transparent;
            opacity: 0; animation: fadeInTooltip 0.3s forwards;
            filter: drop-shadow(0 -2px 1px rgba(0,0,0,0.05));
        }
        @keyframes fadeInTooltip { to { opacity: 1; } }

        .btn-upload { color: #3388ff; } .btn-upload:hover { background: #f0f7ff; }
        .btn-clear { color: #e74c3c; } .btn-clear:hover { background: #fff0f0; }
        .btn-share { color: #8e44ad; } .btn-share:hover { background: #f5eef8; }
        .btn-email { color: #e67e22; } .btn-email:hover { background: #fff8e1; }
        .btn-library { color: #27ae60; } .btn-library:hover { background: #e8f8f5; }

        #file-input { display: none; }

        .logo-box {
            position: absolute; bottom: 30px; left: 20px; z-index: 9999;
            width: 150px; height: auto; pointer-events: none;
            filter: drop-shadow(0px 0px 5px rgba(255,255,255,0.8));
        }

        /* Î£Ï„Ï…Î» Î³Î¹Î± Ï„Î¿ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ Î¥ÏˆÎ¿Î¼ÎµÏ„ÏÎ¹ÎºÎ®Ï‚ */
        #elevation-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 800px; height: 240px;
            background: rgba(255, 255, 255, 0.95); border-radius: 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 2000;
            padding: 10px 20px 10px 10px; display: none; flex-direction: column;
        }
        .elevation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 14px; font-weight: bold; color: #333; }
        .elevation-actions { display: flex; gap: 10px; }
        .ai-analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 5px 12px;
            border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; position: relative;
        }
        .ai-analyze-btn:hover { transform: scale(1.05); }
        .close-chart-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #888; }
        .close-chart-btn:hover { color: #000; }
        #elevationChart { width: 100% !important; height: 180px !important; }

        /* Chat Styles */
        .chat-fab {
            position: absolute; bottom: 30px; right: 20px; z-index: 3000;
            width: 60px; height: 60px; background: #2e7d32; border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex;
            justify-content: center; align-items: center; cursor: pointer;
            color: white; font-size: 24px; transition: transform 0.3s;
        }
        .chat-fab:hover { transform: scale(1.1); background: #1b5e20; }
        .chat-window {
            position: absolute; bottom: 100px; right: 20px; width: 300px; height: 400px;
            background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 3000; display: none; flex-direction: column; overflow: hidden; border: 1px solid #ddd;
        }
        .chat-header { background: #2e7d32; color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; font-size: 13px; }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 10px; max-width: 80%; word-wrap: break-word; }
        .msg-user { background: #e8f5e9; align-self: flex-end; margin-left: auto; color: #1b5e20; }
        .msg-ai { background: #fff; border: 1px solid #eee; align-self: flex-start; color: #333; }
        .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; background: white; }
        .chat-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .chat-send-btn { background: #2e7d32; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .typing-indicator { font-style: italic; color: #888; font-size: 12px; display: none; margin: 5px; }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 5000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px;
            max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
            position: relative;
        }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #888; }
        .ai-result-title { font-size: 18px; font-weight: bold; color: #667eea; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;}
        
        /* Î£Ï„Ï…Î» Î³Î¹Î± Ï„Î· Î›Î¯ÏƒÏ„Î± Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·Ï‚ */
        .library-section-title { font-size: 14px; color: #666; font-weight: bold; margin: 15px 0 5px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .library-list { list-style: none; padding: 0; margin: 0; }
        .library-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #eee; transition: background 0.1s;
        }
        .library-item:hover { background: #f9f9f9; }
        .library-item:last-child { border-bottom: none; }
        .library-name { cursor: pointer; color: #333; font-weight: 500; flex: 1; display: flex; align-items: center; gap: 8px;}
        .library-name:hover { color: #3388ff; }
        .library-delete {
            color: #e74c3c; cursor: pointer; padding: 5px; margin-left: 10px;
        }
        .library-delete:hover { background: #fff0f0; border-radius: 4px; }
        .empty-library { text-align: center; color: #888; padding: 10px; font-size: 13px; font-style: italic; }

    </style>
</head>
<body>

    <div class="info-box">
        <h2>Î•Î˜Î•Î›ÎŸÎÎ¤Î™ÎšÎ— Î”Î¡Î‘Î£Î— Î Î‘Î¡ÎÎ—Î˜Î‘Î£</h2>
        <p>Î§Î¬ÏÏ„Î·Ï‚ Î´ÏÎ¬ÏƒÎ·Ï‚ Î® Î ÎµÎ¶Î¿Ï€Î¿ÏÎ¹ÎºÎ®Ï‚ Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚</p>
    </div>

    <!-- ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ ÎµÎ»Î­Î³Ï‡Î¿Ï… -->
    <div class="controls-box">
        <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ Upload -->
        <button class="control-btn btn-upload" 
                data-tooltip="Î¦Î¿ÏÏ„ÏÏƒÏ„Îµ Î±ÏÏ‡ÎµÎ¯Î¿ Î³Î¹Î± Ï€ÏÎ¿Î²Î¿Î»Î® Î´Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚"
                onclick="document.getElementById('file-input').click()">
            <i class="fas fa-folder-open"></i> Î¦ÏŒÏÏ„Ï‰ÏƒÎ· GPX
        </button>
        
        <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·Ï‚ -->
        <button class="control-btn btn-library" 
                data-tooltip="Î›Î¯ÏƒÏ„Î± Î´Î¹Î±Î´ÏÎ¿Î¼ÏÎ½ (GitHub & Î¤Î¿Ï€Î¹ÎºÎ¬)"
                onclick="openLibrary()">
            <i class="fas fa-book"></i> Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·
        </button>

        <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ Share -->
        <button class="control-btn btn-share" 
                data-tooltip="Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÏƒÏ…Î½Î´Î­ÏƒÎ¼Î¿Ï… Î´Î¹Î±Î¼Î¿Î¯ÏÎ±ÏƒÎ·Ï‚"
                onclick="createShareLink()">
            <i class="fas fa-link"></i> ÎœÎ¿Î¹ÏÎ¬ÏƒÎ¿Ï… Ï„Î¿
        </button>

        <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ Clear -->
        <button class="control-btn btn-clear" 
                data-tooltip="Î”Î¹Î±Î³ÏÎ±Ï†Î® Î´Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚"
                onclick="clearRoutes()">
            <i class="fas fa-trash"></i> ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚
        </button>
        
        <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ Email -->
        <button class="control-btn btn-email" 
                data-tooltip="Î£Ï„ÎµÎ¯Î»Ï„Îµ Î¼Î±Ï‚ Ï„Î¹Ï‚ ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚ ÏƒÎ±Ï‚"
                onclick="window.location.href='mailto:info@drasiparnithas.gr?subject=Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± Î±Ï€ÏŒ Ï„Î¿Î½ Î¨Î·Ï†Î¹Î±ÎºÏŒ Î§Î¬ÏÏ„Î·'">
            <i class="fas fa-envelope"></i> Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±
        </button>
        
        <input type="file" id="file-input" accept=".gpx" onchange="handleFileSelect(event)">
    </div>

    <img src="https://lh3.googleusercontent.com/a-/ALV-UjUCO8MgQJshwSQ6QbDEBjR4OLVCwN3-3eB3-9L4XwPCvNf2YM4=s265-w265-h265" 
         alt="Î›Î¿Î³ÏŒÏ„Ï…Ï€Î¿ Î•.Î”.Î Î‘" 
         class="logo-box"
         onerror="this.style.display='none';">

    <!-- Î Î±ÏÎ¬Î¸Ï…ÏÎ¿ Î¥ÏˆÎ¿Î¼ÎµÏ„ÏÎ¹ÎºÎ®Ï‚ ÎšÎ±Î¼Ï€ÏÎ»Î·Ï‚ -->
    <div id="elevation-container">
        <div class="elevation-header">
            <div class="elevation-actions">
                <span>Î¥ÏˆÎ¿Î¼ÎµÏ„ÏÎ¹ÎºÎ® ÎšÎ±Î¼Ï€ÏÎ»Î·</span>
                <button id="ai-btn" class="ai-analyze-btn" data-tooltip="Î“Î¹Î± Î½Î± Î­Ï‡ÎµÏ„Îµ Ï„Î¿Î½ Î²Î¿Î·Î¸ÏŒ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯ÏƒÏ„Îµ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Î¹ ÏƒÏ„Î¿ Google" onclick="analyzeRouteWithAI()">
                    âœ¨ AI ÎŸÎ´Î·Î³ÏŒÏ‚ Î’Î¿Ï…Î½Î¿Ï
                </button>
            </div>
            <button class="close-chart-btn" onclick="closeElevationChart()">Ã—</button>
        </div>
        <canvas id="elevationChart"></canvas>
    </div>

    <!-- Chat Window -->
    <div class="chat-fab" onclick="toggleChat()"><i class="fas fa-tree"></i></div>
    <div class="chat-window" id="chatWindow">
        <div class="chat-header"><span>ğŸŒ² ÎŸÎ´Î·Î³ÏŒÏ‚ Î Î¬ÏÎ½Î·Î¸Î±Ï‚ (AI)</span><span style="cursor:pointer" onclick="toggleChat()">_</span></div>
        <div class="chat-messages" id="chatMessages"><div class="message msg-ai">Î“ÎµÎ¹Î± ÏƒÎ±Ï‚! Î•Î¯Î¼Î±Î¹ Î¿ ÏˆÎ·Ï†Î¹Î±ÎºÏŒÏ‚ ÏƒÎ±Ï‚ Î´Î±ÏƒÎ¿Ï†ÏÎ»Î±ÎºÎ±Ï‚. Î¡Ï‰Ï„Î®ÏƒÏ„Îµ Î¼Îµ Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ Î³Î¹Î± Ï„Î·Î½ Î Î¬ÏÎ½Î·Î¸Î±!</div></div>
        <div class="typing-indicator" id="typingIndicator">ÎŸ Î¿Î´Î·Î³ÏŒÏ‚ Ï€Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³ÎµÎ¯...</div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="Î¡ÏÏ„Î± ÎºÎ¬Ï„Î¹..." onkeypress="handleEnter(event)">
            <button class="chat-send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- Modal Î‘Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½ AI -->
    <div class="modal-overlay" id="aiModal" onclick="closeAiModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAiModal(null)">&times;</span>
            <div class="ai-result-title"><i class="fas fa-robot"></i> Î‘Î½Î¬Î»Ï…ÏƒÎ· Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚ Gemini</div>
            <div id="aiModalContent">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Î½Î¬Î»Ï…ÏƒÎ·Ï‚...</div>
        </div>
    </div>

    <!-- Modal Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·Ï‚ -->
    <div class="modal-overlay" id="libraryModal" onclick="closeLibraryModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeLibraryModal(null)">&times;</span>
            <div class="ai-result-title"><i class="fas fa-book"></i> Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· Î”Î¹Î±Î´ÏÎ¿Î¼ÏÎ½</div>
            <div id="libraryContent">
                <!-- Î•Î½ÏŒÏ„Î·Ï„Î± GitHub -->
                <div class="library-section-title">â˜ï¸ Cloud Î”Î¹Î±Î´ÏÎ¿Î¼Î­Ï‚ (GitHub)</div>
                <div id="githubLoading" style="text-align:center; padding:10px; font-size:12px; color:#666;">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Ï€ÏŒ GitHub...</div>
                <ul class="library-list" id="githubList"></ul>
                
                <!-- Î•Î½ÏŒÏ„Î·Ï„Î± Î¤Î¿Ï€Î¹ÎºÏÎ½ -->
                <div class="library-section-title" style="margin-top:20px;">ğŸ’¾ Î¤Î¿Ï€Î¹ÎºÎ¬ Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½ÎµÏ‚</div>
                <ul class="library-list" id="localList"></ul>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const apiKey = ""; 
        const map = L.map('map').setView([38.168, 23.722], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap contributors' }).addTo(map);

        const gpxLayerGroup = L.layerGroup().addTo(map);
        let elevationChart = null;
        let currentRouteData = null;

        // Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± GitHub Repository
        const GITHUB_USER = 'EDPAdraseis';
        const GITHUB_REPO = 'map';

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const gpxUrl = urlParams.get('gpx');
            if (gpxUrl) loadGpxFromUrl(gpxUrl);
        };

        // --- Î’Î™Î’Î›Î™ÎŸÎ˜Î—ÎšÎ— (GitHub & Local) ---
        const STORAGE_KEY = 'parnitha_saved_routes';

        // 1. Fetch from GitHub
        async function fetchGitHubFiles() {
            const listEl = document.getElementById('githubList');
            const loadingEl = document.getElementById('githubLoading');
            listEl.innerHTML = '';
            loadingEl.style.display = 'block';

            try {
                // Î§ÏÎ®ÏƒÎ· Ï„Î¿Ï… GitHub API Î³Î¹Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ· Ï„Ï‰Î½ Ï€ÎµÏÎ¹ÎµÏ‡Î¿Î¼Î­Î½Ï‰Î½
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/`);
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                // Î¦Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î± Î¼ÏŒÎ½Î¿ Ï„Ï‰Î½ Î±ÏÏ‡ÎµÎ¯Ï‰Î½ .gpx
                const gpxFiles = data.filter(item => item.name.endsWith('.gpx'));

                loadingEl.style.display = 'none';

                if (gpxFiles.length === 0) {
                    listEl.innerHTML = '<li class="empty-library">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±ÏÏ‡ÎµÎ¯Î± .gpx ÏƒÏ„Î¿ GitHub repository.</li>';
                    return;
                }

                gpxFiles.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'library-item';
                    
                    // Î§ÏÎ®ÏƒÎ· download_url Î³Î¹Î± Î¬Î¼ÎµÏƒÎ· Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ raw Î±ÏÏ‡ÎµÎ¯Î¿
                    li.innerHTML = `
                        <span class="library-name" onclick="loadAndCloseLibrary('${file.download_url}')">
                            <i class="fas fa-cloud" style="color:#3498db; margin-right:8px;"></i> ${file.name}
                        </span>
                    `;
                    listEl.appendChild(li);
                });

            } catch (error) {
                console.error("GitHub Fetch Error:", error);
                loadingEl.innerHTML = 'Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î® Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÏÏ‡ÎµÎ¯Î±.';
            }
        }

        // 2. Local Storage Logic
        function saveRouteToStorage(name, gpxData) {
            try {
                let routes = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                const exists = routes.some(r => r.name === name);
                if (!exists) {
                    routes.push({ name: name, data: gpxData, date: new Date().toISOString() });
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(routes));
                }
            } catch (e) {
                console.error("Storage error:", e);
                alert("Î— Î¼Î½Î®Î¼Î· Ï„Î¿Ï… browser Î³Î­Î¼Î¹ÏƒÎµ! Î”Î¹Î±Î³ÏÎ¬ÏˆÏ„Îµ Ï€Î±Î»Î¹Î­Ï‚ Î´Î¹Î±Î´ÏÎ¿Î¼Î­Ï‚.");
            }
        }

        function getLocalRoutes() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        }

        function deleteLocalRoute(name) {
            let routes = getLocalRoutes();
            routes = routes.filter(r => r.name !== name);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(routes));
            renderLocalLibrary(); // Refresh list
        }

        function renderLocalLibrary() {
            const listEl = document.getElementById('localList');
            listEl.innerHTML = '';
            const routes = getLocalRoutes();

            if (routes.length === 0) {
                listEl.innerHTML = '<li class="empty-library">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï„Î¿Ï€Î¹ÎºÎ­Ï‚ Î´Î¹Î±Î´ÏÎ¿Î¼Î­Ï‚.</li>';
                return;
            }

            routes.forEach(route => {
                const li = document.createElement('li');
                li.className = 'library-item';
                
                // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Blob URL Î³Î¹Î± Ï„Î± Ï„Î¿Ï€Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î±
                const blob = new Blob([route.data], {type: 'application/gpx+xml'});
                const url = URL.createObjectURL(blob);

                li.innerHTML = `
                    <span class="library-name" onclick="loadAndCloseLibrary('${url}')">
                        <i class="fas fa-file-code" style="color:#f39c12; margin-right:8px;"></i> ${route.name}
                    </span>
                    <i class="fas fa-trash library-delete" onclick="deleteLocalRoute('${route.name}')" title="Î”Î¹Î±Î³ÏÎ±Ï†Î®"></i>
                `;
                listEl.appendChild(li);
            });
        }

        // --- Library UI Functions ---
        function openLibrary() {
            document.getElementById('libraryModal').style.display = 'flex';
            fetchGitHubFiles(); // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Ï€ÏŒ GitHub
            renderLocalLibrary(); // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¿Ï€Î¹ÎºÏÎ½
        }

        function closeLibraryModal(e) {
            if (!e || e.target.id === 'libraryModal' || e.target.classList.contains('modal-close')) {
                document.getElementById('libraryModal').style.display = 'none';
            }
        }

        function loadAndCloseLibrary(url) {
            loadGpxFromUrl(url);
            document.getElementById('libraryModal').style.display = 'none';
        }


        // --- Î¥Ï€ÏŒÎ»Î¿Î¹Ï€ÎµÏ‚ Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚ (Î¦ÏŒÏÏ„Ï‰ÏƒÎ·, AI, ÎºÎ»Ï€) ---

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const gpxData = e.target.result;
                // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î¿Ï€Î¹ÎºÎ¬
                saveRouteToStorage(file.name, gpxData);
                
                // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·
                const blob = new Blob([gpxData], {type: 'text/xml'});
                const url = URL.createObjectURL(blob);
                loadGpxFromUrl(url);
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function loadGpxFromUrl(url) {
            gpxLayerGroup.clearLayers();
            closeElevationChart();
            currentRouteData = null;
            document.getElementById('ai-btn').style.display = 'none';

            new L.GPX(url, {
                async: true,
                marker_options: {
                    startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-start.png',
                    endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-end.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-shadow.png'
                },
                polyline_options: {
                    color: 'blue', opacity: 0.8, weight: 6, lineCap: 'round'
                }
            }).on('loaded', function(e) {
                const gpx = e.target;
                map.fitBounds(gpx.getBounds());
                
                const dist = (gpx.get_distance() / 1000).toFixed(2);
                const gain = gpx.get_elevation_gain().toFixed(0);
                const minEle = gpx.get_elevation_min().toFixed(0);
                const maxEle = gpx.get_elevation_max().toFixed(0);

                currentRouteData = { dist, gain, minEle, maxEle };
                
                const elevationData = gpx.get_elevation_data();
                if (elevationData && elevationData.length > 0) {
                    drawElevationChart(elevationData);
                    document.getElementById('ai-btn').style.display = 'block';
                }
            }).addTo(gpxLayerGroup);
        }

        // --- AI & Share (Î Î±ÏÎ±Î¼Î­Î½Î¿Ï…Î½ Î¯Î´Î¹Î±) ---
        function createShareLink() {
            const userUrl = prompt("Î•Ï€Î¹ÎºÎ¿Î»Î»Î®ÏƒÏ„Îµ ÎµÎ´Ï Ï„Î¿ Î¬Î¼ÎµÏƒÎ¿ link (URL) Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï… GPX:\n(Î .Ï‡. https://example.com/route.gpx)");
            if (userUrl) {
                const baseUrl = window.location.href.split('?')[0];
                const shareUrl = `${baseUrl}?gpx=${encodeURIComponent(userUrl)}`;
                navigator.clipboard.writeText(shareUrl).then(() => alert("âœ… Link Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ!"), () => prompt("Link:", shareUrl));
            }
        }
        
        async function callGemini(prompt) {
             const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const delays = [1000, 2000, 4000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error();
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error";
                } catch (error) {
                    if (i === delays.length) return getMockResponse(prompt);
                    await new Promise(res => setTimeout(res, delays[i]));
                }
            }
        }

        function getMockResponse(prompt) {
            if (prompt.includes("Î‘Î½Î¬Î»Ï…ÏƒÎµ Ï„Î·Î½ ÎµÎ¾Î®Ï‚ Ï€ÎµÎ¶Î¿Ï€Î¿ÏÎ¹ÎºÎ® Î´Î¹Î±Î´ÏÎ¿Î¼Î®")) {
                return `<b>(Demo Mode)</b><br>Î‘Î½Î¬Î»Ï…ÏƒÎ·: Î”Ï…ÏƒÎºÎ¿Î»Î¯Î± ÎœÎ­Ï„ÏÎ¹Î±, Î§ÏÏŒÎ½Î¿Ï‚ 2-3 ÏÏÎµÏ‚.`;
            } else {
                return "Î“ÎµÎ¹Î± ÏƒÎ±Ï‚! (Demo Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·)";
            }
        }

        async function analyzeRouteWithAI() {
            if (!currentRouteData) return;
            document.getElementById('aiModal').style.display = 'flex';
            document.getElementById('aiModalContent').innerHTML = '<div style="text-align:center">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>';
            const prompt = `Î‘Î½Î¬Î»Ï…ÏƒÎµ Î´Î¹Î±Î´ÏÎ¿Î¼Î® Î Î¬ÏÎ½Î·Î¸Î±Ï‚: ${currentRouteData.dist}km, +${currentRouteData.gain}m gain.`;
            const response = await callGemini(prompt);
            document.getElementById('aiModalContent').innerHTML = response.replace(/\*\*/g, '<b>').replace(/\*\*/g, '</b>').replace(/\n/g, '<br>');
        }
        function closeAiModal(e) { if (!e || e.target.id === 'aiModal' || e.target.classList.contains('modal-close')) document.getElementById('aiModal').style.display = 'none'; }
        
        function toggleChat() { 
            const w = document.getElementById('chatWindow'); 
            w.style.display = w.style.display === 'flex' ? 'none' : 'flex'; 
        }
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim(); if(!msg) return;
            addMessage(msg, 'msg-user'); input.value='';
            const res = await callGemini(`User asked: ${msg}. Reply as Parnitha ranger.`);
            addMessage(res, 'msg-ai');
        }
        function addMessage(t, c) {
            const d = document.createElement('div'); d.className = `message ${c}`; d.innerText = t;
            const b = document.getElementById('chatMessages'); b.appendChild(d); b.scrollTop = b.scrollHeight;
        }
        
        function clearRoutes() {
            gpxLayerGroup.clearLayers(); closeElevationChart(); currentRouteData=null; map.setView([38.168, 23.722], 14);
        }
        
        function drawElevationChart(data) {
            const container = document.getElementById('elevation-container');
            container.style.display = 'flex';
            const ctx = document.getElementById('elevationChart').getContext('2d');
            const sampleRate = Math.ceil(data.length / 500);
            const chartLabels = [], chartData = [];
            for (let i = 0; i < data.length; i += sampleRate) {
                chartLabels.push(data[i][0].toFixed(1)); chartData.push(data[i][1]);
            }
            if (elevationChart) elevationChart.destroy();
            elevationChart = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: [{ label: 'Î¥ÏˆÏŒÎ¼ÎµÏ„ÏÎ¿', data: chartData, borderColor: '#2e7d32', backgroundColor: 'rgba(46,125,50,0.1)', fill: true, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: true }, y: { display: true } } }
            });
        }
        function closeElevationChart() { document.getElementById('elevation-container').style.display = 'none'; if(elevationChart) elevationChart.destroy(); }

    </script>
</body>
</html>
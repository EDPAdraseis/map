<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Î§Î¬ÏÏ„Î·Ï‚ Î Î¬ÏÎ½Î·Î¸Î±Ï‚ - Route Planner (ORS Hiking)</title>

  <!-- Leaflet + Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

  <style>
    html, body { height:100%; margin:0; font-family: Arial, sans-serif; }
    #map { height:100%; width:100%; }

    .controls {
      position:absolute; top:12px; right:12px; z-index:2000;
      display:flex; gap:8px; flex-wrap:wrap;
      background: rgba(255,255,255,0.92); padding:10px; border-radius:12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    }
    .btn {
      border:0; border-radius:10px; padding:10px 12px; cursor:pointer;
      font-weight:700; font-size:13px;
      box-shadow: 0 3px 0 rgba(0,0,0,0.20);
      background:#f2f2f2;
    }
    .btn:active { transform: translateY(3px); box-shadow: 0 0 0 rgba(0,0,0,0.20); }
    .btn.primary { background:#8e44ad; color:#fff; }
    .btn.warn { background:#f39c12; color:#111; }
    .btn.danger { background:#c0392b; color:#fff; }
    .btn.good { background:#2ecc71; color:#0b2a16; }
    .badge {
      position:absolute; top:12px; left:12px; z-index:2000;
      background: rgba(255,255,255,0.92); padding:10px 12px; border-radius:12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      max-width: 320px;
    }
    .badge h2 { margin:0; font-size:14px; color:#2e7d32; letter-spacing:0.2px; }
    .badge p { margin:4px 0 0 0; font-size:12px; color:#555; }

    .planner {
      position:absolute; left:50%; bottom:18px; transform: translateX(-50%);
      z-index:2500;
      width: min(760px, 92vw);
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.20);
      padding: 14px;
      display:none;
      border-bottom: 6px solid #8e44ad;
    }
    .planner .title { font-weight:900; color:#8e44ad; text-align:center; }
    .planner .sub { text-align:center; font-size:12px; color:#666; margin-top:6px; }
    .planner .stats {
      display:flex; gap:14px; justify-content:center; margin-top:12px; flex-wrap:wrap;
      background:#f5f5f7; border-radius:12px; padding:10px;
    }
    .stat { min-width:140px; text-align:center; }
    .stat .val { font-size:20px; font-weight:900; }
    .stat .lbl { font-size:11px; color:#666; margin-top:2px; text-transform:uppercase; }

    .planner .actions {
      display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap;
    }

    /* hide the default routing panel */
    .leaflet-routing-container { display:none !important; }

    @media (max-width: 640px) {
      .controls { left:12px; right:auto; max-width: 92vw; }
      .badge { max-width: 70vw; }
    }
  </style>
</head>
<body>
  <div class="badge">
    <h2>Î•Î˜Î•Î›ÎŸÎÎ¤Î™ÎšÎ— Î”Î¡Î‘Î£Î— Î Î‘Î¡ÎÎ—Î˜Î‘Î£</h2>
    <p>Î£Ï‡ÎµÎ´Î¯Î±ÏƒÎ· Î´Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚ Ï€Î¬Î½Ï‰ ÏƒÎµ Î¼Î¿Î½Î¿Ï€Î¬Ï„Î¹Î± Î¼Îµ ORS (foot-hiking).</p>
  </div>

  <div class="controls">
    <button class="btn" id="homeBtn">Home</button>
    <button class="btn primary" id="planBtn">Î£Ï‡ÎµÎ´Î¯Î±ÏƒÎ·</button>
    <button class="btn" id="undoBtn" disabled>Undo</button>
    <button class="btn warn" id="modeBtn" disabled>âœï¸ Manual</button>
    <button class="btn good" id="saveBtn" disabled>Save GPX</button>
    <button class="btn danger" id="exitBtn" disabled>Exit</button>
  </div>

  <div class="planner" id="planner">
    <div class="title">ğŸ—ºï¸ Î£Î§Î•Î”Î™Î‘Î£ÎœÎŸÎ£ Î Î•Î–ÎŸÎ ÎŸÎ¡Î™Î‘Î£</div>
    <div class="sub">
      ÎšÎ»Î¹Îº Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚ ÏƒÎ·Î¼ÎµÎ¯Î±.<br>
      Î‘Î½ Î´ÎµÎ½ Î²ÏÎ¯ÏƒÎºÎµÎ¹ Î¼Î¿Î½Î¿Ï€Î¬Ï„Î¹ (ORS), Ï€Î¬Ï„Î± Manual.
    </div>

    <div class="stats">
      <div class="stat"><div class="val" id="distVal">0.00</div><div class="lbl">Î§Î›Îœ</div></div>
      <div class="stat"><div class="val" id="timeVal">0Î»</div><div class="lbl">Î•ÎšÎ¤. Î§Î¡ÎŸÎÎŸÎ£</div></div>
    </div>

    <div class="actions">
      <button class="btn good" id="saveBtn2">Save GPX</button>
      <button class="btn warn" id="modeBtn2">âœï¸ Manual</button>
      <button class="btn" id="undoBtn2">Undo</button>
      <button class="btn danger" id="exitBtn2">Exit</button>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <script>
    // =========================
    // 1) ORS KEY (Î¤ÎŸ "ÎšÎ•Î›Î™Î”Î™" Î£ÎŸÎ¥)
    // =========================
    const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjQxMmMxN2IzMzkyMjRmOTc5NDlhODY0MjVlYTNlYjJmIiwiaCI6Im11cm11cjY0In0=";

    // =========================
    // 2) MAP SETUP
    // =========================
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "Â© OpenStreetMap"
    });

    const topo = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
      maxZoom: 17,
      attribution: "Â© OpenTopoMap, Â© OpenStreetMap"
    });

    const map = L.map("map", { zoomControl: true, layers: [osm] }).setView([38.168, 23.722], 14);
    L.control.layers({ "OSM": osm, "Topo": topo }).addTo(map);

    // =========================
    // 3) ROUTE PLANNER STATE
    // =========================
    let isPlanning = false;
    let isManualMode = false;
    let routeWaypoints = [];
    let manualLayer = L.layerGroup().addTo(map);
    let manualLine = null;

    // Leaflet Routing Machine control (for ORS mode)
    let routingControl = null;

    // =========================
    // 4) CUSTOM ORS ROUTER FOR LRM
    //    Calls ORS v2 directions (foot-hiking) and returns a route geometry.
    // =========================
    function createOrsRouter() {
      return L.Class.extend({
        options: {},
        initialize: function() {},

        route: function(waypoints, callback, context, options) {
          // Need at least 2 points
          if (!waypoints || waypoints.length < 2) {
            callback.call(context, null, []);
            return;
          }

          // ORS expects [lon, lat]
          const coords = waypoints.map(wp => [wp.latLng.lng, wp.latLng.lat]);

          fetch("https://api.openrouteservice.org/v2/directions/foot-hiking/geojson", {
            method: "POST",
            headers: {
              "Authorization": ORS_API_KEY,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              coordinates: coords,
              instructions: false
            })
          })
          .then(async (res) => {
            if (!res.ok) {
              const txt = await res.text().catch(() => "");
              throw new Error("ORS error: " + res.status + " " + txt);
            }
            return res.json();
          })
          .then((geojson) => {
            const feat = geojson && geojson.features && geojson.features[0];
            if (!feat || !feat.geometry || !feat.geometry.coordinates) {
              throw new Error("ORS: no geometry");
            }

            const line = feat.geometry.coordinates.map(c => L.latLng(c[1], c[0]));
            const seg = (feat.properties && feat.properties.segments && feat.properties.segments[0]) || null;

            // ORS summary
            const distM = seg && seg.distance ? seg.distance : (feat.properties && feat.properties.summary && feat.properties.summary.distance) || 0;
            const timeS = seg && seg.duration ? seg.duration : (feat.properties && feat.properties.summary && feat.properties.summary.duration) || 0;

            const route = {
              name: "ORS Hiking",
              coordinates: line,
              summary: { totalDistance: distM, totalTime: timeS },
              inputWaypoints: waypoints,
              waypoints: waypoints
            };

            callback.call(context, null, [route]);
          })
          .catch((err) => {
            // If ORS fails, return empty so UI doesn't "freeze"
            console.error(err);
            callback.call(context, err, []);
          });
        }
      });
    }

    function initRoutingControl() {
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }

      const OrsRouterClass = createOrsRouter();
      const orsRouter = new OrsRouterClass();

      routingControl = L.Routing.control({
        waypoints: [],
        show: false,
        routeWhileDragging: false,
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: false,
        lineOptions: { styles: [{ color: "#8e44ad", opacity: 0.9, weight: 6 }] },
        createMarker: function(i, wp) {
          return L.marker(wp.latLng, {
            draggable: false,
            icon: L.divIcon({
              className: "custom-div-icon",
              html: '<div style="background:#8e44ad;width:18px;height:18px;border-radius:50%;border:2px solid #fff;"></div>',
              iconSize: [18, 18],
              iconAnchor: [9, 9]
            })
          });
        },
        router: orsRouter
      }).addTo(map);

      routingControl.on("routesfound", function(e) {
        const r = e.routes && e.routes[0];
        if (!r || !r.summary) return;
        updateStats(r.summary.totalDistance, r.summary.totalTime);
      });

      routingControl.on("routingerror", function(e) {
        // Î‘Î½ Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹ ORS, Î¼Î· Î¼Î­Î½ÎµÎ¹Ï‚ Î¾ÎµÎºÏÎ­Î¼Î±ÏƒÏ„Î¿Ï‚, Î´ÎµÎ¯Î¾Îµ Î¼Î®Î½Ï…Î¼Î± ÎºÎ±Î¹ Ï€ÏÏŒÏ„ÎµÎ¹Î½Îµ Manual
        console.warn("Routing error:", e);
        // Î”ÎµÎ½ Ï€ÎµÏ„Î¬Î¼Îµ alert ÎºÎ¬Î¸Îµ Ï†Î¿ÏÎ¬ Î³Î¹Î± Î½Î± Î¼Î·Î½ ÎµÎ¯Î½Î±Î¹ ÏƒÏ€Î±ÏƒÏ„Î¹ÎºÏŒ
      });
    }

    // =========================
    // 5) UI HELPERS
    // =========================
    function updateStats(distMeters, timeSeconds) {
      const km = (distMeters / 1000) || 0;
      const mins = Math.round((timeSeconds || 0) / 60);
      document.getElementById("distVal").innerText = km.toFixed(2);
      document.getElementById("timeVal").innerText = mins + "Î»";
    }

    function resetStats() {
      document.getElementById("distVal").innerText = "0.00";
      document.getElementById("timeVal").innerText = "0Î»";
    }

    function updateButtons() {
      const has2 = routeWaypoints.length >= 2;
      document.getElementById("undoBtn").disabled = !isPlanning || routeWaypoints.length === 0;
      document.getElementById("modeBtn").disabled = !isPlanning;
      document.getElementById("saveBtn").disabled = !isPlanning || !has2;
      document.getElementById("exitBtn").disabled = !isPlanning;

      document.getElementById("undoBtn2").disabled = !isPlanning || routeWaypoints.length === 0;
      document.getElementById("modeBtn2").disabled = !isPlanning;
      document.getElementById("saveBtn2").disabled = !isPlanning || !has2;
      document.getElementById("exitBtn2").disabled = !isPlanning;

      const label = isManualMode ? "ğŸ¤– Auto" : "âœï¸ Manual";
      document.getElementById("modeBtn").innerText = label;
      document.getElementById("modeBtn2").innerText = label;
    }

    function setPlannerVisible(vis) {
      document.getElementById("planner").style.display = vis ? "block" : "none";
    }

    // =========================
    // 6) MANUAL MODE (always works)
    // =========================
    function renderManual() {
      manualLayer.clearLayers();
      if (routeWaypoints.length === 0) { resetStats(); return; }

      // markers
      routeWaypoints.forEach((pt) => {
        L.marker(pt, {
          icon: L.divIcon({
            className: "custom-div-icon",
            html: '<div style="background:#8e44ad;width:18px;height:18px;border-radius:50%;border:2px solid #fff;"></div>',
            iconSize: [18,18],
            iconAnchor: [9,9]
          })
        }).addTo(manualLayer);
      });

      if (routeWaypoints.length >= 2) {
        manualLine = L.polyline(routeWaypoints, { color:"#8e44ad", weight:6, opacity:0.9, dashArray:"10,10" }).addTo(manualLayer);

        // distance
        let dist = 0;
        for (let i=0; i<routeWaypoints.length-1; i++) {
          dist += map.distance(routeWaypoints[i], routeWaypoints[i+1]);
        }
        // estimate time at 4 km/h
        const km = dist/1000;
        const mins = Math.round((km/4) * 60);
        updateStats(dist, mins*60);
      } else {
        resetStats();
      }
    }

    // =========================
    // 7) ORS MODE
    // =========================
    function renderORS() {
      manualLayer.clearLayers();
      if (!routingControl) initRoutingControl();
      routingControl.setWaypoints(routeWaypoints.map(ll => L.Routing.waypoint(ll)));
      if (routeWaypoints.length < 2) resetStats();
    }

    function rerender() {
      if (!isPlanning) return;
      if (isManualMode) renderManual();
      else renderORS();
      updateButtons();
    }

    // =========================
    // 8) START/STOP PLANNER
    // =========================
    function startPlanner() {
      isPlanning = true;
      isManualMode = false; // start in ORS (like Wikiloc)
      routeWaypoints = [];
      resetStats();
      setPlannerVisible(true);
      if (!routingControl) initRoutingControl();
      routingControl.setWaypoints([]);
      manualLayer.clearLayers();
      map.getContainer().style.cursor = "crosshair";
      updateButtons();
    }

    function stopPlanner() {
      isPlanning = false;
      routeWaypoints = [];
      resetStats();
      setPlannerVisible(false);
      manualLayer.clearLayers();
      if (routingControl) {
        routingControl.setWaypoints([]);
      }
      map.getContainer().style.cursor = "";
      updateButtons();
    }

    // =========================
    // 9) GPX EXPORT (planned route)
    //    In ORS mode we export the computed route geometry (if available),
    //    else fallback to waypoints.
    // =========================
    function exportPlannedGpx() {
      if (routeWaypoints.length < 2) {
        alert("Î’Î¬Î»Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 2 ÏƒÎ·Î¼ÎµÎ¯Î±.");
        return;
      }

      let coords = [];

      if (!isManualMode && routingControl && routingControl._routes && routingControl._routes.length > 0) {
        coords = routingControl._routes[0].coordinates || [];
      }

      if (!coords || coords.length < 2) {
        // fallback
        coords = routeWaypoints;
      }

      const now = new Date();
      const date = now.toISOString().slice(0,10);
      const name = "Parnitha_Plan_" + date;

      let gpx = '<?xml version="1.0" encoding="UTF-8"?>\n';
      gpx += '<gpx version="1.1" creator="ParnithaMap" xmlns="http://www.topografix.com/GPX/1/1">\n';
      gpx += '  <trk>\n';
      gpx += `    <name>${name}</name>\n`;
      gpx += '    <trkseg>\n';
      coords.forEach(pt => {
        gpx += `      <trkpt lat="${pt.lat}" lon="${pt.lng}"></trkpt>\n`;
      });
      gpx += '    </trkseg>\n';
      gpx += '  </trk>\n';
      gpx += '</gpx>\n';

      const blob = new Blob([gpx], { type: "application/gpx+xml" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = name + ".gpx";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // =========================
    // 10) EVENTS
    // =========================
    map.on("click", function(e) {
      if (!isPlanning) return;
      routeWaypoints.push(e.latlng);
      rerender();
    });

    // Buttons (top)
    document.getElementById("homeBtn").addEventListener("click", () => map.setView([38.168, 23.722], 14));
    document.getElementById("planBtn").addEventListener("click", () => isPlanning ? stopPlanner() : startPlanner());
    document.getElementById("undoBtn").addEventListener("click", () => { routeWaypoints.pop(); rerender(); });
    document.getElementById("modeBtn").addEventListener("click", () => { isManualMode = !isManualMode; rerender(); });
    document.getElementById("saveBtn").addEventListener("click", exportPlannedGpx);
    document.getElementById("exitBtn").addEventListener("click", stopPlanner);

    // Buttons (panel)
    document.getElementById("undoBtn2").addEventListener("click", () => { routeWaypoints.pop(); rerender(); });
    document.getElementById("modeBtn2").addEventListener("click", () => { isManualMode = !isManualMode; rerender(); });
    document.getElementById("saveBtn2").addEventListener("click", exportPlannedGpx);
    document.getElementById("exitBtn2").addEventListener("click", stopPlanner);

    // Start in normal view
    updateButtons();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î§Î¬ÏÏ„Î·Ï‚ Î Î¬ÏÎ½Î·Î¸Î±Ï‚ - AI Edition</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        #map { width: 100%; height: 100vh; z-index: 1; }

        /* Î£Ï„Ï…Î» Î³Î¹Î± Ï„Î¿ Popup */
        .custom-popup .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
            text-align: center;
        }
        .popup-title { font-size: 18px; font-weight: bold; color: #2c3e50; display: block; }
        .popup-desc { font-size: 14px; color: #555; }

        /* ÎšÎ¿Ï…Ï„Î¯ Ï„Î¯Ï„Î»Î¿Ï… */
        .info-box {
            position: absolute; top: 20px; left: 60px; /* Î›Î¯Î³Î¿ Ï€Î¹Î¿ Î´ÎµÎ¾Î¹Î¬ Î³Î¹Î± Î½Î± Î¼Î·Î½ Ï€Î­Ï†Ï„ÎµÎ¹ Ï€Î¬Î½Ï‰ ÏƒÏ„Î± zoom controls */
            z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); max-width: 250px;
        }
        .info-box h2 { margin: 0 0 5px 0; font-size: 18px; color: #2e7d32; }
        .info-box p { margin: 0; font-size: 12px; color: #666; }

        /* ÎšÎ¿Ï…Ï„Î¹Î¬ Î•Î»Î­Î³Ï‡Î¿Ï… */
        .controls-box {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            display: flex; gap: 10px;
            flex-wrap: wrap; 
            justify-content: flex-end;
            max-width: 60%; /* Î“Î¹Î± Î½Î± Î¼Î·Î½ Ï€Î­Ï†Ï„ÎµÎ¹ Ï€Î¬Î½Ï‰ ÏƒÏ„Î¿ info box */
        }
        
        .control-btn {
            background: white; border: none; padding: 10px 15px;
            border-radius: 8px; cursor: pointer; font-size: 14px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            transition: background 0.2s;
            font-weight: bold;
            display: flex; align-items: center; gap: 5px;
            position: relative;
            white-space: nowrap; /* ÎÎ± Î¼Î·Î½ ÏƒÏ€Î¬ÎµÎ¹ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ */
        }

        /* --- TOOLTIP STYLES --- */
        .control-btn[data-tooltip]:hover::after,
        .ai-analyze-btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 115%; left: 50%; transform: translateX(-50%);
            background-color: white; color: #333;
            padding: 8px 12px; border-radius: 6px; font-size: 13px;
            white-space: nowrap; opacity: 0; animation: fadeInTooltip 0.3s forwards;
            pointer-events: none; box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            z-index: 1001; border: 1px solid #f0f0f0; font-weight: normal;
        }
        /* ÎšÏÏÎ²Î¿Ï…Î¼Îµ Ï„Î± tooltips ÏƒÏ„Î± ÎºÎ¹Î½Î·Ï„Î¬ Î³Î¹Î± Î½Î± Î¼Î·Î½ ÎµÎ½Î¿Ï‡Î»Î¿ÏÎ½ ÏƒÏ„Î¿ touch */
        @media (hover: none) {
            .control-btn[data-tooltip]:hover::after,
            .control-btn[data-tooltip]:hover::before,
            .ai-analyze-btn[data-tooltip]:hover::after,
            .ai-analyze-btn[data-tooltip]:hover::before {
                display: none;
            }
        }

        .control-btn[data-tooltip]:hover::before,
        .ai-analyze-btn[data-tooltip]:hover::before {
            content: ''; position: absolute; top: 105%; left: 50%;
            transform: translateX(-50%); border-width: 6px; border-style: solid;
            border-color: transparent transparent white transparent;
            opacity: 0; animation: fadeInTooltip 0.3s forwards;
            filter: drop-shadow(0 -2px 1px rgba(0,0,0,0.05));
        }
        @keyframes fadeInTooltip { to { opacity: 1; } }

        .btn-upload { color: #3388ff; } .btn-upload:hover { background: #f0f7ff; }
        .btn-clear { color: #e74c3c; } .btn-clear:hover { background: #fff0f0; }
        .btn-share { color: #8e44ad; } .btn-share:hover { background: #f5eef8; }
        .btn-email { color: #e67e22; } .btn-email:hover { background: #fff8e1; }
        .btn-library { color: #27ae60; } .btn-library:hover { background: #e8f8f5; }
        .btn-settings { color: #7f8c8d; } .btn-settings:hover { background: #f2f4f4; }

        #file-input { display: none; }

        .logo-box {
            position: absolute; bottom: 30px; left: 20px; z-index: 9999;
            width: 150px; height: auto; pointer-events: none;
            filter: drop-shadow(0px 0px 5px rgba(255,255,255,0.8));
            transition: width 0.3s; /* Smooth animation */
        }

        /* Î£Ï„Ï…Î» Î³Î¹Î± Ï„Î¿ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ Î¥ÏˆÎ¿Î¼ÎµÏ„ÏÎ¹ÎºÎ®Ï‚ */
        #elevation-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 800px; height: 240px;
            background: rgba(255, 255, 255, 0.95); border-radius: 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 2000;
            padding: 10px 20px 10px 10px; display: none; flex-direction: column;
        }
        .elevation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 14px; font-weight: bold; color: #333; }
        .elevation-actions { display: flex; gap: 10px; }
        .ai-analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 5px 12px;
            border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; position: relative;
        }
        .ai-analyze-btn:hover { transform: scale(1.05); }
        .close-chart-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #888; }
        .close-chart-btn:hover { color: #000; }
        #elevationChart { width: 100% !important; height: 180px !important; }

        /* Chat Styles */
        .chat-fab {
            position: absolute; bottom: 30px; right: 20px; z-index: 3000;
            width: 60px; height: 60px; background: #2e7d32; border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex;
            justify-content: center; align-items: center; cursor: pointer;
            color: white; font-size: 24px; transition: transform 0.3s;
        }
        .chat-fab:hover { transform: scale(1.1); background: #1b5e20; }
        
        .chat-window {
            position: absolute; bottom: 100px; right: 20px; width: 300px; height: 400px;
            background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 3000; display: none; flex-direction: column; overflow: hidden; border: 1px solid #ddd;
        }
        
        .chat-header { background: #2e7d32; color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; font-size: 13px; }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 10px; max-width: 80%; word-wrap: break-word; }
        .msg-user { background: #e8f5e9; align-self: flex-end; margin-left: auto; color: #1b5e20; }
        .msg-ai { background: #fff; border: 1px solid #eee; align-self: flex-start; color: #333; }
        .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; background: white; }
        .chat-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .chat-send-btn { background: #2e7d32; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .typing-indicator { font-style: italic; color: #888; font-size: 12px; display: none; margin: 5px; }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 5000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px;
            max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
            position: relative;
        }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #888; }
        .ai-result-title { font-size: 18px; font-weight: bold; color: #667eea; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;}
        
        /* Library Styles */
        .library-section-title { font-size: 14px; color: #666; font-weight: bold; margin: 15px 0 5px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .library-list { list-style: none; padding: 0; margin: 0; }
        .library-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #eee; transition: background 0.1s;
        }
        .library-item:hover { background: #f9f9f9; }
        .library-item:last-child { border-bottom: none; }
        .library-name { cursor: pointer; color: #333; font-weight: 500; flex: 1; display: flex; align-items: center; gap: 8px;}
        .library-name:hover { color: #3388ff; }
        .library-delete { color: #e74c3c; cursor: pointer; padding: 5px; margin-left: 10px; }
        .library-delete:hover { background: #fff0f0; border-radius: 4px; }
        .empty-library { text-align: center; color: #888; padding: 10px; font-size: 13px; font-style: italic; }

        /* Settings Modal Styles */
        .settings-input {
            width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 14px;
        }
        .settings-save-btn {
            background: #2e7d32; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%;
        }
        .settings-help { font-size: 12px; color: #666; line-height: 1.5; margin-bottom: 15px; }
        .settings-help a { color: #3388ff; }

        /* --- MEDIA QUERIES Î“Î™Î‘ MOBILE --- */
        @media (max-width: 768px) {
            /* Info Box: Î Î¹Î¿ ÏƒÏ…Î¼Ï€Î±Î³Î­Ï‚ ÎºÎ±Î¹ Î¼ÎµÏ„Î±ÎºÎ¯Î½Î·ÏƒÎ· Î³Î¹Î± Î½Î± Î¼Î· ÎºÏÏÎ²ÎµÎ¹ Ï„Î¿ Ï‡Î¬ÏÏ„Î· */
            .info-box {
                top: 10px;
                left: 50px; /* Î”Î¯Ï€Î»Î± Î±Ï€ÏŒ Ï„Î± controls */
                padding: 10px;
                max-width: 180px;
            }
            .info-box h2 { font-size: 14px; }
            .info-box p { display: none; } /* ÎšÏÏÎ²Î¿Ï…Î¼Îµ Ï„Î·Î½ Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î® ÏƒÏ„Î± Ï€Î¿Î»Ï Î¼Î¹ÎºÏÎ¬ ÎºÎ¹Î½Î·Ï„Î¬ */

            /* Controls: Î Î¹Î¿ Î¼Î¹ÎºÏÎ¬ ÎºÎ¿Ï…Î¼Ï€Î¹Î¬, ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ· ÎºÎ¬Ï„Ï‰ Î±Ï€ÏŒ Ï„Î¿ info box Î® Î´Î¯Ï€Î»Î± */
            .controls-box {
                top: 70px; /* ÎšÎ¬Ï„Ï‰ Î±Ï€ÏŒ Ï„Î¿ info box Î±Î½ Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î® Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬ */
                left: 10px;
                right: auto;
                justify-content: flex-start;
                max-width: 90%;
                gap: 5px;
            }
            .control-btn {
                padding: 8px 10px;
                font-size: 12px;
            }

            /* Chat Window: Î Î»Î®ÏÎµÏ‚ Ï€Î»Î¬Ï„Î¿Ï‚ ÏƒÏ‡ÎµÎ´ÏŒÎ½ */
            .chat-window {
                width: 90%;
                right: 5%;
                bottom: 90px;
                height: 50vh;
            }

            /* Logo: ÎœÎ¹ÎºÏÎ±Î¯Î½ÎµÎ¹ */
            .logo-box {
                width: 100px;
                bottom: 25px;
                left: 10px;
            }

            /* Elevation Chart: Î Î¹Î¿ Ï†Î±ÏÎ´Ï */
            #elevation-container {
                width: 95%;
                height: 200px;
                bottom: 10px;
            }
        }
    </style>
</head>
<body>

    <div class="info-box">
        <h2>Î•Î˜Î•Î›ÎŸÎÎ¤Î™ÎšÎ— Î”Î¡Î‘Î£Î— Î Î‘Î¡ÎÎ—Î˜Î‘Î£</h2>
        <p>Î§Î¬ÏÏ„Î·Ï‚ Î´ÏÎ¬ÏƒÎ·Ï‚ Î® Î ÎµÎ¶Î¿Ï€Î¿ÏÎ¹ÎºÎ®Ï‚ Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚</p>
    </div>

    <!-- ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ ÎµÎ»Î­Î³Ï‡Î¿Ï… -->
    <div class="controls-box">
        <button class="control-btn btn-upload" data-tooltip="Î¦Î¿ÏÏ„ÏÏƒÏ„Îµ Î±ÏÏ‡ÎµÎ¯Î¿ Î³Î¹Î± Ï€ÏÎ¿Î²Î¿Î»Î® Î´Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-folder-open"></i> Î¦ÏŒÏÏ„Ï‰ÏƒÎ· GPX
        </button>
        
        <button class="control-btn btn-library" data-tooltip="Î›Î¯ÏƒÏ„Î± Î´Î¹Î±Î´ÏÎ¿Î¼ÏÎ½ (GitHub & Î¤Î¿Ï€Î¹ÎºÎ¬)" onclick="openLibrary()">
            <i class="fas fa-book"></i> Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·
        </button>

        <button class="control-btn btn-share" data-tooltip="Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÏƒÏ…Î½Î´Î­ÏƒÎ¼Î¿Ï… Î´Î¹Î±Î¼Î¿Î¯ÏÎ±ÏƒÎ·Ï‚" onclick="createShareLink()">
            <i class="fas fa-link"></i> ÎœÎ¿Î¹ÏÎ¬ÏƒÎ¿Ï… Ï„Î¿
        </button>

        <button class="control-btn btn-clear" data-tooltip="Î”Î¹Î±Î³ÏÎ±Ï†Î® Î´Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚" onclick="clearRoutes()">
            <i class="fas fa-trash"></i> ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚
        </button>
        
        <button class="control-btn btn-email" data-tooltip="Î£Ï„ÎµÎ¯Î»Ï„Îµ Î¼Î±Ï‚ Ï„Î¹Ï‚ ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚ ÏƒÎ±Ï‚" onclick="window.location.href='mailto:info@drasiparnithas.gr?subject=Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± Î±Ï€ÏŒ Ï„Î¿Î½ Î¨Î·Ï†Î¹Î±ÎºÏŒ Î§Î¬ÏÏ„Î·'">
            <i class="fas fa-envelope"></i> Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±
        </button>

        <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÏ‰Î½ (ÎÎ•ÎŸ) -->
        <button class="control-btn btn-settings" data-tooltip="Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ AI (Gemini Key)" onclick="openSettings()">
            <i class="fas fa-cog"></i>
        </button>
        
        <input type="file" id="file-input" accept=".gpx" onchange="handleFileSelect(event)">
    </div>

    <img src="https://lh3.googleusercontent.com/a-/ALV-UjUCO8MgQJshwSQ6QbDEBjR4OLVCwN3-3eB3-9L4XwPCvNf2YM4=s265-w265-h265" 
         alt="Î›Î¿Î³ÏŒÏ„Ï…Ï€Î¿ Î•.Î”.Î Î‘" 
         class="logo-box"
         onerror="this.style.display='none';">

    <!-- Î Î±ÏÎ¬Î¸Ï…ÏÎ¿ Î¥ÏˆÎ¿Î¼ÎµÏ„ÏÎ¹ÎºÎ®Ï‚ -->
    <div id="elevation-container">
        <div class="elevation-header">
            <div class="elevation-actions">
                <span>Î¥ÏˆÎ¿Î¼ÎµÏ„ÏÎ¹ÎºÎ® ÎšÎ±Î¼Ï€ÏÎ»Î·</span>
                <button id="ai-btn" class="ai-analyze-btn" data-tooltip="Î–Î·Ï„Î®ÏƒÏ„Îµ Î±Î½Î¬Î»Ï…ÏƒÎ· Ï„Î·Ï‚ Î´Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚ Î±Ï€ÏŒ Ï„Î¿ Gemini AI" onclick="analyzeRouteWithAI()">
                    âœ¨ AI ÎŸÎ´Î·Î³ÏŒÏ‚ Î’Î¿Ï…Î½Î¿Ï
                </button>
            </div>
            <button class="close-chart-btn" onclick="closeElevationChart()">Ã—</button>
        </div>
        <canvas id="elevationChart"></canvas>
    </div>

    <!-- Chat -->
    <div class="chat-fab" onclick="toggleChat()"><i class="fas fa-tree"></i></div>
    <div class="chat-window" id="chatWindow">
        <div class="chat-header"><span>ğŸŒ² ÎŸÎ´Î·Î³ÏŒÏ‚ Î Î¬ÏÎ½Î·Î¸Î±Ï‚ (AI)</span><span style="cursor:pointer" onclick="toggleChat()">_</span></div>
        <div class="chat-messages" id="chatMessages"><div class="message msg-ai">Î“ÎµÎ¹Î± ÏƒÎ±Ï‚! Î•Î¯Î¼Î±Î¹ Î¿ ÏˆÎ·Ï†Î¹Î±ÎºÏŒÏ‚ ÏƒÎ±Ï‚ Î´Î±ÏƒÎ¿Ï†ÏÎ»Î±ÎºÎ±Ï‚. Î¡Ï‰Ï„Î®ÏƒÏ„Îµ Î¼Îµ Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ Î³Î¹Î± Ï„Î·Î½ Î Î¬ÏÎ½Î·Î¸Î±!</div></div>
        <div class="typing-indicator" id="typingIndicator">ÎŸ Î¿Î´Î·Î³ÏŒÏ‚ Ï€Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³ÎµÎ¯...</div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="Î¡ÏÏ„Î± ÎºÎ¬Ï„Î¹..." onkeypress="handleEnter(event)">
            <button class="chat-send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- Modal Î‘Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½ AI -->
    <div class="modal-overlay" id="aiModal" onclick="closeAiModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAiModal(null)">&times;</span>
            <div class="ai-result-title"><i class="fas fa-robot"></i> Î‘Î½Î¬Î»Ï…ÏƒÎ· Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚ Gemini</div>
            <div id="aiModalContent">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Î½Î¬Î»Ï…ÏƒÎ·Ï‚...</div>
        </div>
    </div>

    <!-- Modal Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·Ï‚ -->
    <div class="modal-overlay" id="libraryModal" onclick="closeLibraryModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeLibraryModal(null)">&times;</span>
            <div class="ai-result-title"><i class="fas fa-book"></i> Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· Î”Î¹Î±Î´ÏÎ¿Î¼ÏÎ½</div>
            <div id="libraryContent">
                <div class="library-section-title">â˜ï¸ Cloud Î”Î¹Î±Î´ÏÎ¿Î¼Î­Ï‚ (GitHub)</div>
                <div id="githubLoading" style="text-align:center; padding:10px; font-size:12px; color:#666;">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Ï€ÏŒ GitHub...</div>
                <ul class="library-list" id="githubList"></ul>
                <div class="library-section-title" style="margin-top:20px;">ğŸ’¾ Î¤Î¿Ï€Î¹ÎºÎ¬ Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½ÎµÏ‚</div>
                <ul class="library-list" id="localList"></ul>
            </div>
        </div>
    </div>

    <!-- Modal Î¡Ï…Î¸Î¼Î¯ÏƒÎµÏ‰Î½ (ÎÎ•ÎŸ) -->
    <div class="modal-overlay" id="settingsModal" onclick="closeSettingsModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeSettingsModal(null)">&times;</span>
            <div class="ai-result-title"><i class="fas fa-cog"></i> Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ AI</div>
            <div class="settings-help">
                Î“Î¹Î± Î½Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î¿ AI ÎŸÎ´Î·Î³ÏŒÏ‚, Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î­Î½Î± <b>Google Gemini API Key</b>.<br><br>
                1. Î Î·Î³Î±Î¯Î½ÎµÏ„Îµ ÏƒÏ„Î¿ <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.<br>
                2. Î Î±Ï„Î®ÏƒÏ„Îµ "Create API Key".<br>
                3. Î‘Î½Ï„Î¹Î³ÏÎ¬ÏˆÏ„Îµ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ ÎºÎ±Î¹ ÎµÏ€Î¹ÎºÎ¿Î»Î»Î®ÏƒÏ„Îµ Ï„Î¿ ÎµÎ´Ï.<br>
                <small>Î¤Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ ÏƒÏ„Î¿Î½ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î® ÏƒÎ±Ï‚ (browser).</small>
            </div>
            <input type="password" id="apiKeyInput" class="settings-input" placeholder="Î•Ï€Î¹ÎºÎ¿Î»Î»Î®ÏƒÏ„Îµ Ï„Î¿ API Key ÎµÎ´Ï...">
            <button class="settings-save-btn" onclick="saveApiKey()">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        </div>
    </div>

    <div id="map"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- Î”Î™Î‘Î§Î•Î™Î¡Î™Î£Î— API KEY ---
        // Î¤Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Ï€Î»Î­Î¿Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ±, Î±Î»Î»Î¬ ÏƒÏ„Î¿ LocalStorage Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
        function getApiKey() {
            return localStorage.getItem('gemini_api_key') || "";
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                alert("Î¤Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! ÎŸ AI ÎŸÎ´Î·Î³ÏŒÏ‚ ÎµÎ¯Î½Î±Î¹ Î­Ï„Î¿Î¹Î¼Î¿Ï‚.");
                closeSettingsModal(null);
            } else {
                alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î½Î± Î­Î³ÎºÏ…ÏÎ¿ ÎºÎ»ÎµÎ¹Î´Î¯.");
            }
        }

        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            document.getElementById('apiKeyInput').value = getApiKey();
        }

        function closeSettingsModal(e) {
            if (!e || e.target.id === 'settingsModal' || e.target.classList.contains('modal-close')) {
                document.getElementById('settingsModal').style.display = 'none';
            }
        }

        // --- Î§Î‘Î¡Î¤Î—Î£ & GPX ---
        const map = L.map('map').setView([38.168, 23.722], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap contributors' }).addTo(map);

        const gpxLayerGroup = L.layerGroup().addTo(map);
        let elevationChart = null;
        let currentRouteData = null;
        const GITHUB_USER = 'EDPAdraseis';
        const GITHUB_REPO = 'map';

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const gpxUrl = urlParams.get('gpx');
            if (gpxUrl) loadGpxFromUrl(gpxUrl);
        };

        // --- GEMINI API CALL ---
        async function callGemini(prompt) {
            const userKey = getApiKey();
            
            // Î‘Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î²Î¬Î»ÎµÎ¹ ÎºÎ»ÎµÎ¹Î´Î¯, ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†Î¿Ï…Î¼Îµ Î¼Î®Î½Ï…Î¼Î± Î¿Î´Î·Î³Î¹ÏÎ½
            if (!userKey) {
                return "âš ï¸ Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹ Ï„Î¿ API Key.\nÎ Î±Ï„Î®ÏƒÏ„Îµ Ï„Î¿ Î³ÏÎ±Î½Î¬Î¶Î¹ (âš™ï¸) ÏƒÏ„Î¿ Î¼ÎµÎ½Î¿Ï ÎºÎ±Î¹ Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ Ï„Î¹Ï‚ Î¿Î´Î·Î³Î¯ÎµÏ‚ Î³Î¹Î± Î½Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î¿Î½ AI ÎŸÎ´Î·Î³ÏŒ.";
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const delays = [1000, 2000, 4000];
            
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (!response.ok) {
                        if (response.status === 400 || response.status === 403) {
                            throw new Error("INVALID_KEY");
                        }
                        throw new Error(`HTTP Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ‰ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.";
                } catch (error) {
                    console.error("AI Error:", error);
                    
                    if (error.message === "INVALID_KEY") {
                        return "âŒ Î¤Î¿ API Key Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ¿.\nÎ Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î¿ ÏƒÏ„Î¹Ï‚ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ (âš™ï¸).";
                    }

                    if (i === delays.length) {
                        return "Î¥Ï€Î®ÏÎ¾Îµ Ï€ÏÏŒÎ²Î»Î·Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿ Gemini. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬ Î±ÏÎ³ÏŒÏ„ÎµÏÎ±.";
                    }
                    await new Promise(res => setTimeout(res, delays[i]));
                }
            }
        }

        // --- Î¥Î ÎŸÎ›ÎŸÎ™Î Î•Î£ Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î•Î£ (ÎŠÎ´Î¹ÎµÏ‚ Î¼Îµ Ï€ÏÎ¹Î½) ---
        const STORAGE_KEY = 'parnitha_saved_routes';

        async function fetchGitHubFiles() {
            const listEl = document.getElementById('githubList');
            const loadingEl = document.getElementById('githubLoading');
            listEl.innerHTML = ''; loadingEl.style.display = 'block';
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/`);
                if (!response.ok) throw new Error();
                const data = await response.json();
                const gpxFiles = data.filter(item => item.name.endsWith('.gpx'));
                loadingEl.style.display = 'none';
                if (gpxFiles.length === 0) { listEl.innerHTML = '<li class="empty-library">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±ÏÏ‡ÎµÎ¯Î± .gpx.</li>'; return; }
                gpxFiles.forEach(file => {
                    const li = document.createElement('li'); li.className = 'library-item';
                    li.innerHTML = `<span class="library-name" onclick="loadAndCloseLibrary('${file.download_url}')"><i class="fas fa-cloud" style="color:#3498db; margin-right:8px;"></i> ${file.name}</span>`;
                    listEl.appendChild(li);
                });
            } catch (error) { loadingEl.innerHTML = 'Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î® Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÏÏ‡ÎµÎ¯Î±.'; }
        }

        function saveRouteToStorage(name, gpxData) {
            try {
                let routes = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                if (!routes.some(r => r.name === name)) {
                    routes.push({ name: name, data: gpxData });
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(routes));
                }
            } catch (e) { alert("Storage full!"); }
        }
        function getLocalRoutes() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
        function deleteLocalRoute(name) {
            let routes = getLocalRoutes().filter(r => r.name !== name);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(routes)); renderLocalLibrary();
        }
        function renderLocalLibrary() {
            const listEl = document.getElementById('localList'); listEl.innerHTML = '';
            const routes = getLocalRoutes();
            if (routes.length === 0) { listEl.innerHTML = '<li class="empty-library">ÎšÎµÎ½ÏŒ.</li>'; return; }
            routes.forEach(route => {
                const blob = new Blob([route.data], {type: 'application/gpx+xml'});
                const url = URL.createObjectURL(blob);
                const li = document.createElement('li'); li.className = 'library-item';
                li.innerHTML = `<span class="library-name" onclick="loadAndCloseLibrary('${url}')"><i class="fas fa-file-code" style="color:#f39c12; margin-right:8px;"></i> ${route.name}</span><i class="fas fa-trash library-delete" onclick="deleteLocalRoute('${route.name}')"></i>`;
                listEl.appendChild(li);
            });
        }
        function openLibrary() { document.getElementById('libraryModal').style.display = 'flex'; fetchGitHubFiles(); renderLocalLibrary(); }
        function closeLibraryModal(e) { if (!e || e.target.id === 'libraryModal' || e.target.classList.contains('modal-close')) document.getElementById('libraryModal').style.display = 'none'; }
        function loadAndCloseLibrary(url) { loadGpxFromUrl(url); document.getElementById('libraryModal').style.display = 'none'; }

        function handleFileSelect(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                saveRouteToStorage(file.name, e.target.result);
                loadGpxFromUrl(URL.createObjectURL(new Blob([e.target.result], {type: 'text/xml'})));
            };
            reader.readAsText(file); event.target.value = '';
        }

        function loadGpxFromUrl(url) {
            gpxLayerGroup.clearLayers(); closeElevationChart(); currentRouteData=null; document.getElementById('ai-btn').style.display='none';
            new L.GPX(url, { async: true, marker_options: { startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-start.png', endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-end.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-shadow.png' }, polyline_options: { color: 'blue', opacity: 0.8, weight: 6 } }).on('loaded', function(e) {
                map.fitBounds(e.target.getBounds());
                currentRouteData = { dist: (e.target.get_distance()/1000).toFixed(2), gain: e.target.get_elevation_gain().toFixed(0), maxEle: e.target.get_elevation_max().toFixed(0) };
                if (e.target.get_elevation_data().length > 0) { drawElevationChart(e.target.get_elevation_data()); document.getElementById('ai-btn').style.display='block'; }
            }).addTo(gpxLayerGroup);
        }

        function createShareLink() {
            const userUrl = prompt("Link Î±ÏÏ‡ÎµÎ¯Î¿Ï… GPX:");
            if (userUrl) {
                const shareUrl = `${window.location.href.split('?')[0]}?gpx=${encodeURIComponent(userUrl)}`;
                navigator.clipboard.writeText(shareUrl).then(() => alert("Link Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ!"), () => prompt("Link:", shareUrl));
            }
        }

        async function analyzeRouteWithAI() {
            if (!currentRouteData) return;
            document.getElementById('aiModal').style.display = 'flex';
            document.getElementById('aiModalContent').innerHTML = '<div style="text-align:center">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>';
            const prompt = `Î‘Î½Î¬Î»Ï…ÏƒÎµ Î´Î¹Î±Î´ÏÎ¿Î¼Î® Î Î¬ÏÎ½Î·Î¸Î±Ï‚: ${currentRouteData.dist}km, +${currentRouteData.gain}m gain.`;
            const response = await callGemini(prompt);
            document.getElementById('aiModalContent').innerHTML = response.replace(/\*\*/g, '<b>').replace(/\*\*/g, '</b>').replace(/\n/g, '<br>');
        }
        function closeAiModal(e) { if (!e || e.target.id === 'aiModal' || e.target.classList.contains('modal-close')) document.getElementById('aiModal').style.display = 'none'; }
        
        function toggleChat() { const w = document.getElementById('chatWindow'); w.style.display = w.style.display === 'flex' ? 'none' : 'flex'; }
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
        async function sendMessage() {
            const input = document.getElementById('chatInput'); const msg = input.value.trim(); if(!msg) return;
            addMessage(msg, 'msg-user'); input.value='';
            const res = await callGemini(`User asked: ${msg}. Reply as Parnitha ranger.`);
            addMessage(res, 'msg-ai');
        }
        function addMessage(t, c) {
            const d = document.createElement('div'); d.className = `message ${c}`; d.innerText = t;
            const b = document.getElementById('chatMessages'); b.appendChild(d); b.scrollTop = b.scrollHeight;
        }
        function clearRoutes() { gpxLayerGroup.clearLayers(); closeElevationChart(); currentRouteData=null; map.setView([38.168, 23.722], 14); }
        function drawElevationChart(data) {
            const ctx = document.getElementById('elevationChart').getContext('2d'); document.getElementById('elevation-container').style.display='flex';
            if(elevationChart) elevationChart.destroy();
            const labels = [], vals = []; const rate = Math.ceil(data.length/500);
            for(let i=0; i<data.length; i+=rate) { labels.push(data[i][0].toFixed(1)); vals.push(data[i][1]); }
            elevationChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ data: vals, borderColor: '#2e7d32', backgroundColor: 'rgba(46,125,50,0.1)', fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: true }, y: { display: true } } } });
        }
        function closeElevationChart() { document.getElementById('elevation-container').style.display = 'none'; if(elevationChart) elevationChart.destroy(); }
    </script>
</body>
</html>
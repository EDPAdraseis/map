<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î§Î¬ÏÏ„Î·Ï‚ Î Î¬ÏÎ½Î·Î¸Î±Ï‚ - AI Edition</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        #map { width: 100%; height: 100vh; z-index: 1; }

        /* Î£Ï„Ï…Î» Î³Î¹Î± Ï„Î¿ Popup */
        .custom-popup .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
            text-align: center;
        }
        .popup-title { font-size: 18px; font-weight: bold; color: #2c3e50; display: block; }
        .popup-desc { font-size: 14px; color: #555; }

        /* ÎšÎ¿Ï…Ï„Î¯ Ï„Î¯Ï„Î»Î¿Ï… */
        .info-box {
            position: absolute; top: 20px; left: 60px;
            z-index: 1000;
            background: white; padding: 12px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); max-width: 250px;
        }
        .info-box h2 { margin: 0 0 5px 0; font-size: 16px; color: #2e7d32; }
        .info-box p { margin: 0; font-size: 11px; color: #666; }

        /* ÎšÎ¿Ï…Ï„Î¹Î¬ Î•Î»Î­Î³Ï‡Î¿Ï… */
        .controls-box {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            display: flex; gap: 8px;
            flex-wrap: wrap; 
            justify-content: flex-end;
            max-width: 60%;
        }
        
        /* ÎœÎ¹ÎºÏÏŒÏ„ÎµÏÎ± ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ */
        .control-btn {
            background: white; border: none; padding: 6px 12px; /* ÎœÎµÎ¹Ï‰Î¼Î­Î½Î¿ padding */
            border-radius: 6px; cursor: pointer; font-size: 12px; /* ÎœÎ¹ÎºÏÏŒÏ„ÎµÏÎ· Î³ÏÎ±Î¼Î¼Î±Ï„Î¿ÏƒÎµÎ¹ÏÎ¬ */
            box-shadow: 0 0 10px rgba(0,0,0,0.15);
            transition: background 0.2s;
            font-weight: bold;
            display: flex; align-items: center; gap: 5px;
            position: relative;
            white-space: nowrap;
        }

        /* --- TOOLTIP STYLES --- */
        .control-btn[data-tooltip]:hover::after,
        .ai-analyze-btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 115%; left: 50%; transform: translateX(-50%);
            background-color: white; color: #333;
            padding: 6px 10px; border-radius: 6px; font-size: 11px;
            white-space: nowrap; opacity: 0; animation: fadeInTooltip 0.3s forwards;
            pointer-events: none; box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            z-index: 1001; border: 1px solid #f0f0f0; font-weight: normal;
        }
        @media (hover: none) {
            .control-btn[data-tooltip]:hover::after, .control-btn[data-tooltip]:hover::before,
            .ai-analyze-btn[data-tooltip]:hover::after, .ai-analyze-btn[data-tooltip]:hover::before { display: none; }
        }
        .control-btn[data-tooltip]:hover::before,
        .ai-analyze-btn[data-tooltip]:hover::before {
            content: ''; position: absolute; top: 105%; left: 50%;
            transform: translateX(-50%); border-width: 6px; border-style: solid;
            border-color: transparent transparent white transparent;
            opacity: 0; animation: fadeInTooltip 0.3s forwards;
            filter: drop-shadow(0 -2px 1px rgba(0,0,0,0.05));
        }
        @keyframes fadeInTooltip { to { opacity: 1; } }

        /* Î§ÏÏÎ¼Î±Ï„Î± ÎšÎ¿Ï…Î¼Ï€Î¹ÏÎ½ */
        .btn-upload { color: #3388ff; } .btn-upload:hover { background: #f0f7ff; }
        .btn-clear { color: #e74c3c; } .btn-clear:hover { background: #fff0f0; }
        .btn-share { color: #8e44ad; } .btn-share:hover { background: #f5eef8; }
        .btn-email { color: #e67e22; } .btn-email:hover { background: #fff8e1; }
        .btn-library { color: #27ae60; } .btn-library:hover { background: #e8f8f5; }
        .btn-print { color: #34495e; } .btn-print:hover { background: #ebedef; }
        .btn-settings { color: #7f8c8d; } .btn-settings:hover { background: #f2f4f4; }

        #file-input { display: none; }

        .logo-box {
            position: absolute; bottom: 30px; left: 20px; z-index: 9999;
            width: 150px; height: auto; pointer-events: none;
            filter: drop-shadow(0px 0px 5px rgba(255,255,255,0.8));
            transition: width 0.3s;
        }

        /* Elevation Chart */
        #elevation-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 800px; height: 200px; /* Î›Î¯Î³Î¿ Ï€Î¹Î¿ Ï‡Î±Î¼Î·Î»ÏŒ */
            background: rgba(255, 255, 255, 0.95); border-radius: 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 2000;
            padding: 10px 20px 10px 10px; display: none; flex-direction: column;
        }
        .elevation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 13px; font-weight: bold; color: #333; }
        .elevation-actions { display: flex; gap: 10px; }
        .ai-analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 4px 10px;
            border-radius: 20px; cursor: pointer; font-size: 11px; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; position: relative;
        }
        .ai-analyze-btn:hover { transform: scale(1.05); }
        .close-chart-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #888; }
        .close-chart-btn:hover { color: #000; }
        #elevationChart { width: 100% !important; height: 150px !important; }

        /* Chat Styles */
        .chat-fab {
            position: absolute; bottom: 30px; right: 20px; z-index: 3000;
            width: 50px; height: 50px; background: #2e7d32; border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex;
            justify-content: center; align-items: center; cursor: pointer;
            color: white; font-size: 22px; transition: transform 0.3s;
        }
        .chat-fab:hover { transform: scale(1.1); background: #1b5e20; }
        .chat-window {
            position: absolute; bottom: 90px; right: 20px; width: 300px; height: 400px;
            background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 3000; display: none; flex-direction: column; overflow: hidden; border: 1px solid #ddd;
        }
        .chat-header { background: #2e7d32; color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; font-size: 13px; }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 10px; max-width: 80%; word-wrap: break-word; }
        .msg-user { background: #e8f5e9; align-self: flex-end; margin-left: auto; color: #1b5e20; }
        .msg-ai { background: #fff; border: 1px solid #eee; align-self: flex-start; color: #333; }
        .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; background: white; }
        .chat-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .chat-send-btn { background: #2e7d32; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .typing-indicator { font-style: italic; color: #888; font-size: 12px; display: none; margin: 5px; }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 5000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px;
            max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
            position: relative;
        }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #888; }
        .ai-result-title { font-size: 18px; font-weight: bold; color: #667eea; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;}
        
        /* Library Styles */
        .library-section-title { font-size: 14px; color: #666; font-weight: bold; margin: 15px 0 5px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .library-list { list-style: none; padding: 0; margin: 0; }
        .library-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #eee; transition: background 0.1s;
        }
        .library-item:hover { background: #f9f9f9; }
        .library-item:last-child { border-bottom: none; }
        .library-name { cursor: pointer; color: #333; font-weight: 500; flex: 1; display: flex; align-items: center; gap: 8px;}
        .library-name:hover { color: #3388ff; }
        .library-delete { color: #e74c3c; cursor: pointer; padding: 5px; margin-left: 10px; }
        .library-delete:hover { background: #fff0f0; border-radius: 4px; }
        .empty-library { text-align: center; color: #888; padding: 10px; font-size: 13px; font-style: italic; }

        /* Settings Modal Styles */
        .settings-group { margin-bottom: 20px; }
        .settings-label { font-weight: bold; display: block; margin-bottom: 8px; font-size: 14px; color: #333; }
        .settings-input { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; font-size: 13px; }
        .settings-save-btn { background: #2e7d32; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px;}
        .settings-help { font-size: 12px; color: #666; line-height: 1.5; margin-bottom: 15px; }
        .settings-help a { color: #3388ff; }
        
        /* Color/Width Pickers */
        .radio-group { display: flex; gap: 15px; }
        .radio-label { display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px; }
        .color-preview { width: 16px; height: 16px; border-radius: 50%; display: inline-block; border: 1px solid #ddd; }

        /* PRINT STYLES - ÎšÏÏÎ²Î¿Ï…Î¼Îµ Ï„Î± Ï€Î¬Î½Ï„Î± ÎµÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ Ï‡Î¬ÏÏ„Î· ÎºÎ±Î¹ logo */
        @media print {
            .controls-box, .chat-fab, .chat-window, .info-box, .leaflet-control-zoom, #elevation-container {
                display: none !important;
            }
            #map { height: 100vh; width: 100%; }
            .logo-box { bottom: 10px; left: 10px; width: 100px; }
            body { margin: 0; padding: 0; overflow: hidden; }
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .info-box { top: 10px; left: 50px; padding: 8px; max-width: 150px; }
            .info-box h2 { font-size: 12px; }
            .info-box p { display: none; }
            .controls-box { top: 60px; left: 10px; right: auto; justify-content: flex-start; max-width: 95%; gap: 5px; }
            .control-btn { padding: 6px 8px; font-size: 11px; }
            .chat-window { width: 90%; right: 5%; bottom: 80px; height: 50vh; }
            .logo-box { width: 80px; bottom: 20px; left: 10px; }
            #elevation-container { width: 95%; height: 180px; bottom: 10px; }
        }
    </style>
</head>
<body>

    <div class="info-box">
        <h2>Î•Î˜Î•Î›ÎŸÎÎ¤Î™ÎšÎ— Î”Î¡Î‘Î£Î— Î Î‘Î¡ÎÎ—Î˜Î‘Î£</h2>
        <p>Î§Î¬ÏÏ„Î·Ï‚ Î´ÏÎ¬ÏƒÎ·Ï‚ Î® Î ÎµÎ¶Î¿Ï€Î¿ÏÎ¹ÎºÎ®Ï‚ Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚</p>
    </div>

    <!-- ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ ÎµÎ»Î­Î³Ï‡Î¿Ï… -->
    <div class="controls-box">
        <button class="control-btn btn-upload" data-tooltip="Î¦Î¿ÏÏ„ÏÏƒÏ„Îµ Î±ÏÏ‡ÎµÎ¯Î¿ GPX" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-folder-open"></i> Î¦ÏŒÏÏ„Ï‰ÏƒÎ·
        </button>
        
        <button class="control-btn btn-library" data-tooltip="Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· Î”Î¹Î±Î´ÏÎ¿Î¼ÏÎ½" onclick="openLibrary()">
            <i class="fas fa-book"></i>
        </button>

        <button class="control-btn btn-share" data-tooltip="ÎœÎ¿Î¹ÏÎ¬ÏƒÎ¿Ï… Ï„Î¿" onclick="createShareLink()">
            <i class="fas fa-link"></i>
        </button>

        <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ Screenshot/PDF (Print) -->
        <button class="control-btn btn-print" data-tooltip="Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· / Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï‰Ï‚ PDF" onclick="window.print()">
            <i class="fas fa-print"></i> Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·
        </button>
        
        <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ JPG Save -->
        <button class="control-btn btn-print" data-tooltip="Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï‰Ï‚ ÎµÎ¹ÎºÏŒÎ½Î± (JPG)" onclick="saveMapAsImage()">
            <i class="fas fa-camera"></i> JPG
        </button>

        <button class="control-btn btn-clear" data-tooltip="Î”Î¹Î±Î³ÏÎ±Ï†Î®" onclick="clearRoutes()">
            <i class="fas fa-trash"></i>
        </button>
        
        <button class="control-btn btn-email" data-tooltip="Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±" onclick="window.location.href='mailto:info@drasiparnithas.gr?subject=Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± Î±Ï€ÏŒ Ï„Î¿Î½ Î¨Î·Ï†Î¹Î±ÎºÏŒ Î§Î¬ÏÏ„Î·'">
            <i class="fas fa-envelope"></i>
        </button>

        <button class="control-btn btn-settings" data-tooltip="Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚" onclick="openSettings()">
            <i class="fas fa-cog"></i>
        </button>
        
        <input type="file" id="file-input" accept=".gpx" onchange="handleFileSelect(event)">
    </div>

    <img src="https://lh3.googleusercontent.com/a-/ALV-UjUCO8MgQJshwSQ6QbDEBjR4OLVCwN3-3eB3-9L4XwPCvNf2YM4=s265-w265-h265" 
         alt="Î›Î¿Î³ÏŒÏ„Ï…Ï€Î¿ Î•.Î”.Î Î‘" 
         class="logo-box"
         onerror="this.style.display='none';">

    <!-- Î Î±ÏÎ¬Î¸Ï…ÏÎ¿ Î¥ÏˆÎ¿Î¼ÎµÏ„ÏÎ¹ÎºÎ®Ï‚ -->
    <div id="elevation-container">
        <div class="elevation-header">
            <div class="elevation-actions">
                <span>Î¥ÏˆÎ¿Î¼ÎµÏ„ÏÎ¹ÎºÎ® ÎšÎ±Î¼Ï€ÏÎ»Î·</span>
                <button id="ai-btn" class="ai-analyze-btn" data-tooltip="Î–Î·Ï„Î®ÏƒÏ„Îµ Î±Î½Î¬Î»Ï…ÏƒÎ· Ï„Î·Ï‚ Î´Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚ Î±Ï€ÏŒ Ï„Î¿ Gemini AI" onclick="analyzeRouteWithAI()">
                    âœ¨ AI ÎŸÎ´Î·Î³ÏŒÏ‚
                </button>
            </div>
            <button class="close-chart-btn" onclick="closeElevationChart()">Ã—</button>
        </div>
        <canvas id="elevationChart"></canvas>
    </div>

    <!-- Chat -->
    <div class="chat-fab" onclick="toggleChat()"><i class="fas fa-tree"></i></div>
    <div class="chat-window" id="chatWindow">
        <div class="chat-header"><span>ğŸŒ² ÎŸÎ´Î·Î³ÏŒÏ‚ Î Î¬ÏÎ½Î·Î¸Î±Ï‚</span><span style="cursor:pointer" onclick="toggleChat()">_</span></div>
        <div class="chat-messages" id="chatMessages"><div class="message msg-ai">Î“ÎµÎ¹Î± ÏƒÎ±Ï‚! Î•Î¯Î¼Î±Î¹ Î¿ ÏˆÎ·Ï†Î¹Î±ÎºÏŒÏ‚ ÏƒÎ±Ï‚ Î´Î±ÏƒÎ¿Ï†ÏÎ»Î±ÎºÎ±Ï‚. Î¡Ï‰Ï„Î®ÏƒÏ„Îµ Î¼Îµ Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ Î³Î¹Î± Ï„Î·Î½ Î Î¬ÏÎ½Î·Î¸Î±!</div></div>
        <div class="typing-indicator" id="typingIndicator">ÎŸ Î¿Î´Î·Î³ÏŒÏ‚ Ï€Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³ÎµÎ¯...</div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="Î¡ÏÏ„Î± ÎºÎ¬Ï„Î¹..." onkeypress="handleEnter(event)">
            <button class="chat-send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="aiModal" onclick="closeAiModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAiModal(null)">&times;</span>
            <div class="ai-result-title"><i class="fas fa-robot"></i> Î‘Î½Î¬Î»Ï…ÏƒÎ· Gemini</div>
            <div id="aiModalContent">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Î½Î¬Î»Ï…ÏƒÎ·Ï‚...</div>
        </div>
    </div>

    <div class="modal-overlay" id="libraryModal" onclick="closeLibraryModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeLibraryModal(null)">&times;</span>
            <div class="ai-result-title"><i class="fas fa-book"></i> Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·</div>
            <div id="libraryContent">
                <div class="library-section-title">â˜ï¸ Cloud (GitHub)</div>
                <div id="githubLoading" style="text-align:center; padding:10px; font-size:12px; color:#666;">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>
                <ul class="library-list" id="githubList"></ul>
                <div class="library-section-title" style="margin-top:20px;">ğŸ’¾ Î¤Î¿Ï€Î¹ÎºÎ¬</div>
                <ul class="library-list" id="localList"></ul>
            </div>
        </div>
    </div>

    <!-- Modal Î¡Ï…Î¸Î¼Î¯ÏƒÎµÏ‰Î½ -->
    <div class="modal-overlay" id="settingsModal" onclick="closeSettingsModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeSettingsModal(null)">&times;</span>
            <div class="ai-result-title"><i class="fas fa-cog"></i> Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</div>
            
            <!-- Î•Ï€Î¹Î»Î¿Î³Î­Ï‚ Î“ÏÎ±Î¼Î¼Î®Ï‚ -->
            <div class="settings-group">
                <label class="settings-label">Î§ÏÏÎ¼Î± Î“ÏÎ±Î¼Î¼Î®Ï‚:</label>
                <div class="radio-group">
                    <label class="radio-label"><input type="radio" name="lineColor" value="blue" checked> <span class="color-preview" style="background:#3388ff;"></span> ÎœÏ€Î»Îµ</label>
                    <label class="radio-label"><input type="radio" name="lineColor" value="red"> <span class="color-preview" style="background:#e74c3c;"></span> ÎšÏŒÎºÎºÎ¹Î½Î¿</label>
                    <label class="radio-label"><input type="radio" name="lineColor" value="#f1c40f"> <span class="color-preview" style="background:#f1c40f;"></span> ÎšÎ¯Ï„ÏÎ¹Î½Î¿</label>
                </div>
            </div>

            <div class="settings-group">
                <label class="settings-label">Î Î¬Ï‡Î¿Ï‚ Î“ÏÎ±Î¼Î¼Î®Ï‚:</label>
                <div class="radio-group">
                    <label class="radio-label"><input type="radio" name="lineWeight" value="6" checked> ÎœÎµÎ³Î¬Î»Î¿ (Î¤ÏÎ­Ï‡Î¿Î½)</label>
                    <label class="radio-label"><input type="radio" name="lineWeight" value="3"> Î›ÎµÏ€Ï„ÏŒ</label>
                </div>
            </div>

            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

            <div class="settings-group">
                <label class="settings-label">Google API Key (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ):</label>
                <div class="settings-help">Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î­Ï‡ÎµÎ¹ ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ ÎºÎ»ÎµÎ¹Î´Î¯. Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚, Î²Î¬Î»Ï„Îµ Ï„Î¿ ÎµÎ´Ï.</div>
                <input type="password" id="apiKeyInput" class="settings-input" placeholder="Î•Ï€Î¹ÎºÎ¿Î»Î»Î®ÏƒÏ„Îµ Ï„Î¿ API Key...">
            </div>

            <button class="settings-save-btn" onclick="saveSettings()">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î¡Ï…Î¸Î¼Î¯ÏƒÎµÏ‰Î½</button>
        </div>
    </div>

    <div id="map"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Script Î³Î¹Î± Screenshot (html2canvas) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        const GLOBAL_API_KEY = "AIzaSyASDnF3E2gmAvv8WY96wg3m3ZkpAntDUU4"; 
        const STORAGE_KEY = 'parnitha_saved_routes';
        const SETTINGS_KEY = 'parnitha_settings';

        // --- Settings Management ---
        function getSettings() {
            const defaultSettings = { color: '#3388ff', weight: 6 };
            try {
                const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY));
                return { ...defaultSettings, ...saved };
            } catch(e) { return defaultSettings; }
        }

        function saveSettings() {
            // API Key
            const apiKeyInput = document.getElementById('apiKeyInput').value.trim();
            if (apiKeyInput) localStorage.setItem('gemini_api_key', apiKeyInput);
            
            // Visual Settings
            const color = document.querySelector('input[name="lineColor"]:checked').value;
            const weight = parseInt(document.querySelector('input[name="lineWeight"]:checked').value);
            
            const settings = { 
                color: color === 'blue' ? '#3388ff' : (color === 'red' ? '#e74c3c' : color), 
                weight: weight 
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            
            alert("ÎŸÎ¹ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½!");
            closeSettingsModal(null);
            
            // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· Ï†Î¿ÏÏ„Ï‰Î¼Î­Î½Î· Î´Î¹Î±Î´ÏÎ¿Î¼Î®, Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Î¼Îµ Î½Î± Ï„Î·Î½ Î¾Î±Î½Î±Ï†Î¿ÏÏ„ÏÏƒÎ¿Ï…Î¼Îµ, 
            // Î±Î»Î»Î¬ Î³Î¹Î± Î±Ï€Î»ÏŒÏ„Î·Ï„Î± ÎµÏ†Î±ÏÎ¼ÏŒÎ¶Î¿Î½Ï„Î±Î¹ ÏƒÏ„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ·.
            // Î‘Î½ Î¸Î­Î»ÎµÏ„Îµ Î¬Î¼ÎµÏƒÎ· ÎµÏ†Î±ÏÎ¼Î¿Î³Î®, ÎºÎ¬Î½Ï„Îµ reload Ï„Î· ÏƒÎµÎ»Î¯Î´Î±:
            // location.reload(); 
        }

        function openSettings() {
            const settings = getSettings();
            
            // Set Color Radio
            let colorVal = 'blue';
            if (settings.color === '#e74c3c') colorVal = 'red';
            else if (settings.color === '#f1c40f') colorVal = '#f1c40f';
            
            const colorRadio = document.querySelector(`input[name="lineColor"][value="${colorVal}"]`);
            if (colorRadio) colorRadio.checked = true;

            // Set Weight Radio
            const weightRadio = document.querySelector(`input[name="lineWeight"][value="${settings.weight}"]`);
            if (weightRadio) weightRadio.checked = true;

            document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_api_key') || "";
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettingsModal(e) {
            if (!e || e.target.id === 'settingsModal' || e.target.classList.contains('modal-close')) {
                document.getElementById('settingsModal').style.display = 'none';
            }
        }

        // --- Map & GPX ---
        const map = L.map('map').setView([38.168, 23.722], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap' }).addTo(map);
        const gpxLayerGroup = L.layerGroup().addTo(map);
        let elevationChart = null;
        let currentRouteData = null;
        const GITHUB_USER = 'EDPAdraseis';
        const GITHUB_REPO = 'map';

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const gpxUrl = urlParams.get('gpx');
            if (gpxUrl) loadGpxFromUrl(gpxUrl);
        };

        function handleFileSelect(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                saveRouteToStorage(file.name, e.target.result);
                loadGpxFromUrl(URL.createObjectURL(new Blob([e.target.result], {type: 'text/xml'})));
            };
            reader.readAsText(file); event.target.value = '';
        }

        function loadGpxFromUrl(url) {
            gpxLayerGroup.clearLayers(); closeElevationChart(); currentRouteData=null; document.getElementById('ai-btn').style.display='none';
            
            const settings = getSettings(); // Load user settings

            new L.GPX(url, { 
                async: true, 
                marker_options: { 
                    startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-start.png', 
                    endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-end.png', 
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-shadow.png' 
                }, 
                polyline_options: { 
                    color: settings.color, 
                    opacity: 0.8, 
                    weight: settings.weight, 
                    lineCap: 'round' 
                } 
            }).on('loaded', function(e) {
                map.fitBounds(e.target.getBounds());
                currentRouteData = { dist: (e.target.get_distance()/1000).toFixed(2), gain: e.target.get_elevation_gain().toFixed(0), maxEle: e.target.get_elevation_max().toFixed(0) };
                if (e.target.get_elevation_data().length > 0) { drawElevationChart(e.target.get_elevation_data()); document.getElementById('ai-btn').style.display='block'; }
            }).addTo(gpxLayerGroup);
        }

        // --- Screenshot Function ---
        function saveMapAsImage() {
            // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ html2canvas
            // Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: Î›ÏŒÎ³Ï‰ CORS (Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î± browser), Ï„Î± Ï€Î»Î±ÎºÎ¯Î´Î¹Î± Ï„Î¿Ï… Ï‡Î¬ÏÏ„Î· (tiles) Î¯ÏƒÏ‰Ï‚ Î´ÎµÎ½ ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„Î¿ÏÎ½ Î±Î½ Î¿ server Î´ÎµÎ½ Ï„Î¿ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹.
            // To OpenStreetMap ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹.
            
            const mapElement = document.body; // Capture whole body or just #map
            
            // ÎšÏÏÎ²Î¿Ï…Î¼Îµ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¬ Ï„Î± controls Î³Î¹Î± Ï„Î¿ screenshot
            const controls = document.querySelector('.controls-box');
            const chatFab = document.querySelector('.chat-fab');
            const infoBox = document.querySelector('.info-box'); // Î‘Î½ Î¸Î­Î»Î¿Ï…Î¼Îµ Î½Î± Ï„Î¿ ÎºÏÎ±Ï„Î®ÏƒÎ¿Ï…Î¼Îµ, Ï„Î¿ Î±Ï†Î®Î½Î¿Ï…Î¼Îµ
            
            controls.style.display = 'none';
            chatFab.style.display = 'none';

            html2canvas(document.body, {
                useCORS: true, // Î£Î·Î¼Î±Î½Ï„Î¹ÎºÏŒ Î³Î¹Î± Î½Î± Ï†Î¿ÏÏ„ÏÏƒÎ¿Ï…Î½ Ï„Î± tiles
                allowTaint: true,
                scrollY: -window.scrollY
            }).then(canvas => {
                // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ controls
                controls.style.display = 'flex';
                chatFab.style.display = 'flex';

                // Î›Î®ÏˆÎ· ÎµÎ¹ÎºÏŒÎ½Î±Ï‚
                const link = document.createElement('a');
                link.download = 'parnitha-map.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            }).catch(err => {
                console.error(err);
                alert("Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î»Î®ÏˆÎ· ÎµÎ¹ÎºÏŒÎ½Î±Ï‚ (Ï€Î¹Î¸Î±Î½ÏŒÎ½ Î»ÏŒÎ³Ï‰ ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ‰Î½ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ Ï„Î¿Ï… browser). Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Ï„Î·Î½ 'Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·' Î³Î¹Î± PDF.");
                controls.style.display = 'flex';
                chatFab.style.display = 'flex';
            });
        }

        // --- AI & Other Functions (Same as before) ---
        function getApiKey() {
            if (GLOBAL_API_KEY && GLOBAL_API_KEY.length > 5) return GLOBAL_API_KEY;
            return localStorage.getItem('gemini_api_key') || "";
        }
        async function callGemini(prompt) {
            const userKey = getApiKey();
            if (!userKey) return "âš ï¸ Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ ÏÏ…Î¸Î¼Î¹ÏƒÏ„ÎµÎ¯ ÎºÎ»ÎµÎ¹Î´Î¯ AI.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error();
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error";
            } catch (error) { return "Î ÏÏŒÎ²Î»Î·Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ AI."; }
        }
        
        // Library, Share, Charts (Î¯Î´Î¹Î± Î¼Îµ Ï€ÏÎ¹Î½)
        async function fetchGitHubFiles() {
            const listEl = document.getElementById('githubList'); const loadingEl = document.getElementById('githubLoading');
            listEl.innerHTML = ''; loadingEl.style.display = 'block';
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/`);
                const data = await response.json();
                const gpxFiles = data.filter(item => item.name.endsWith('.gpx'));
                loadingEl.style.display = 'none';
                if (gpxFiles.length === 0) { listEl.innerHTML = '<li class="empty-library">ÎšÎµÎ½ÏŒ.</li>'; return; }
                gpxFiles.forEach(file => {
                    const li = document.createElement('li'); li.className = 'library-item';
                    li.innerHTML = `<span class="library-name" onclick="loadAndCloseLibrary('${file.download_url}')"><i class="fas fa-cloud" style="color:#3498db; margin-right:8px;"></i> ${file.name}</span>`;
                    listEl.appendChild(li);
                });
            } catch (error) { loadingEl.innerHTML = 'Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚.'; }
        }
        function saveRouteToStorage(name, gpxData) {
            try {
                let routes = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                if (!routes.some(r => r.name === name)) { routes.push({ name: name, data: gpxData }); localStorage.setItem(STORAGE_KEY, JSON.stringify(routes)); }
            } catch (e) {}
        }
        function getLocalRoutes() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
        function deleteLocalRoute(name) { let routes = getLocalRoutes().filter(r => r.name !== name); localStorage.setItem(STORAGE_KEY, JSON.stringify(routes)); renderLocalLibrary(); }
        function renderLocalLibrary() {
            const listEl = document.getElementById('localList'); listEl.innerHTML = '';
            const routes = getLocalRoutes();
            if (routes.length === 0) { listEl.innerHTML = '<li class="empty-library">ÎšÎµÎ½ÏŒ.</li>'; return; }
            routes.forEach(route => {
                const blob = new Blob([route.data], {type: 'application/gpx+xml'}); const url = URL.createObjectURL(blob);
                const li = document.createElement('li'); li.className = 'library-item';
                li.innerHTML = `<span class="library-name" onclick="loadAndCloseLibrary('${url}')"><i class="fas fa-file-code" style="color:#f39c12; margin-right:8px;"></i> ${route.name}</span><i class="fas fa-trash library-delete" onclick="deleteLocalRoute('${route.name}')"></i>`;
                listEl.appendChild(li);
            });
        }
        function openLibrary() { document.getElementById('libraryModal').style.display = 'flex'; fetchGitHubFiles(); renderLocalLibrary(); }
        function closeLibraryModal(e) { if (!e || e.target.id === 'libraryModal' || e.target.classList.contains('modal-close')) document.getElementById('libraryModal').style.display = 'none'; }
        function loadAndCloseLibrary(url) { loadGpxFromUrl(url); document.getElementById('libraryModal').style.display = 'none'; }
        function createShareLink() { const userUrl = prompt("Link Î±ÏÏ‡ÎµÎ¯Î¿Ï… GPX:"); if (userUrl) { const shareUrl = `${window.location.href.split('?')[0]}?gpx=${encodeURIComponent(userUrl)}`; navigator.clipboard.writeText(shareUrl).then(() => alert("Link Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ!"), () => prompt("Link:", shareUrl)); } }
        async function analyzeRouteWithAI() {
            if (!currentRouteData) return; document.getElementById('aiModal').style.display = 'flex'; document.getElementById('aiModalContent').innerHTML = '<div style="text-align:center">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>';
            const prompt = `Î‘Î½Î¬Î»Ï…ÏƒÎµ Î´Î¹Î±Î´ÏÎ¿Î¼Î® Î Î¬ÏÎ½Î·Î¸Î±Ï‚: ${currentRouteData.dist}km, +${currentRouteData.gain}m gain.`;
            const response = await callGemini(prompt);
            document.getElementById('aiModalContent').innerHTML = response.replace(/\*\*/g, '<b>').replace(/\*\*/g, '</b>').replace(/\n/g, '<br>');
        }
        function closeAiModal(e) { if (!e || e.target.id === 'aiModal' || e.target.classList.contains('modal-close')) document.getElementById('aiModal').style.display = 'none'; }
        function toggleChat() { const w = document.getElementById('chatWindow'); w.style.display = w.style.display === 'flex' ? 'none' : 'flex'; }
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
        async function sendMessage() {
            const input = document.getElementById('chatInput'); const msg = input.value.trim(); if(!msg) return;
            addMessage(msg, 'msg-user'); input.value='';
            const res = await callGemini(`User asked: ${msg}. Reply as Parnitha ranger.`);
            addMessage(res, 'msg-ai');
        }
        function addMessage(t, c) { const d = document.createElement('div'); d.className = `message ${c}`; d.innerText = t; const b = document.getElementById('chatMessages'); b.appendChild(d); b.scrollTop = b.scrollHeight; }
        function clearRoutes() { gpxLayerGroup.clearLayers(); closeElevationChart(); currentRouteData=null; map.setView([38.168, 23.722], 14); }
        function drawElevationChart(data) {
            const ctx = document.getElementById('elevationChart').getContext('2d'); document.getElementById('elevation-container').style.display='flex';
            if(elevationChart) elevationChart.destroy();
            const labels = [], vals = []; const rate = Math.ceil(data.length/500);
            for(let i=0; i<data.length; i+=rate) { labels.push(data[i][0].toFixed(1)); vals.push(data[i][1]); }
            elevationChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ data: vals, borderColor: '#2e7d32', backgroundColor: 'rgba(46,125,50,0.1)', fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: true }, y: { display: true } } } });
        }
        function closeElevationChart() { document.getElementById('elevation-container').style.display = 'none'; if(elevationChart) elevationChart.destroy(); }
    </script>
</body>
</html>